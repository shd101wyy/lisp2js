var node_environment=!1,vm=null;"undefined"!=typeof module&&(vm=require("vm"),node_environment=!0);var $List,car,cdr,cons,list,list_module,__slice=[].slice;
list_module=function(){var m,q,b;m=function(b,h){this.first=b;this.rest=h;return null};m.prototype.length=function(){var b;b=function(h,n){return null===h?n:b(h.rest,n+1)};return b(this,0)};m.prototype.toString=function(){var b;b=function(h,n){return null===h?n+")":h instanceof m?b(h.rest,n+(null===h.first?"()":h.first.toString())+(null===h.rest?"":", ")):n.slice(0,-2)+" . "+h.toString()+")"};return b(this,"(")};m.prototype.reverse=function(){var b;b=function(h,n){return h instanceof m?b(h.rest,q(h.first,
n)):null===h?n:q(h,n)};return b(this,null)};m.prototype.slice=function(b,h){var n,m,s;null==h&&(h=null);if(null===h)return 0>b&&(b=this.length()+b),m=function(b,h){return 0===h?b:m(b.rest,h-1)},m(this,b);if(0>b||0>h)n=this.length(),b=0>b?n+b:b,h=0>h?n+h:h;s=function(b,h,n){return 0===h?0===n||null===b?null:q(b.first,s(b.rest,h,n-1)):s(b.rest,h-1,n)};return s(this,b,h-b)};m.prototype.ref=function(b){var h;0>b&&(b=this.length()+b);h=function(b,r){return null===b?null:0===r?b.first:h(b.rest,r-1)};return h(this,
b)};m.prototype.append=function(){var r,h;h=1<=arguments.length?__slice.call(arguments,0):[];h=b.apply(b,h);r=function(b,h){return null===b?h:q(b.first,r(b.rest,h))};return r(this,h)};m.prototype.toArray=function(){var b,h;b=[];h=function(n){if(null===n)return b;b.push(n.first);return h(n.rest)};return h(this)};m.prototype.forEach=function(b){var h;h=function(n){if(null===n)return null;b(n.first);return h(n.rest)};return h(this)};m.prototype.foreach=m.prototype.forEach;m.prototype.map=function(b){var h;
h=function(n){return null===n?null:q(b(n.first),h(n.rest))};return h(this)};m.prototype.filter=function(b){var h;h=function(n){return null===n?null:b(n.first)?q(n.first,h(n.rest)):h(n.rest)};return h(this)};q=function(b,h){return new m(b,h)};b=function(){var b,h;b=1<=arguments.length?__slice.call(arguments,0):[];h=function(b,m){return m===b.length?null:q(b[m],h(b,m+1))};return h(b,0)};return{list:b,cons:q,List:m,car:function(b){return b.first},cdr:function(b){return b.rest}}}();$List=list_module.List;
list=list_module.list;cons=list_module.cons;car=list_module.car;cdr=list_module.cdr;"undefined"!==typeof module&&(module.exports.$List=$List,module.exports.list=list,module.exports.cons=cons,module.exports.car=car,module.exports.cdr=cdr);
var lisp_module=function(){var m,q,b,r,h={},n="",y=null,s=0,z=function(a,e){return null===a?e instanceof $List||null===e?e:cons(e,null):cons(a.first,z(a.rest,e))};node_environment?y=vm.createContext({cons:cons,car:car,cdr:cdr,list:list,$List:$List,append:z,console:console}):window.append=z;m=function(a){for(var e=[],b=0,c=0;c<a.length;c++)if("("===a[c])e.push("("),b++;else if("["===a[c]){if(0!==c&&" "!==a[c-1]&&"\n"!==a[c-1]&&"\t"!==a[c-1]&&"'"!==a[c-1]&&"`"!==a[c-1]&&"~"!==a[c-1]&&"("!==a[c-1]&&
"{"!==a[c-1]&&"["!==a[c-1])if(d=e.length-1,g=")"===e[d]?1:0,0===g)e.push("get"),e.push(e[d]),e[d]="(";else{e.push("");e.push("");e[d+2]=e[d];for(--d;;){e[d+2]=e[d];")"===e[d]&&g++;"("===e[d]&&g--;if(0===g)break;d--}e[d]="(";e[d+1]="get"}else e.push("("),e.push("Array");b++}else if("{"===a[c])e.push("("),e.push("Object"),b++;else if(")"===a[c]||"]"===a[c]||"}"===a[c])e.push(")"),b--;else if(" "!==a[c]&&"\n"!==a[c]&&"\t"!=a[c]&&","!=a[c])if("~"===a[c]&&"@"===a[c+1])e.push("~@"),c++;else if("`"===a[c]||
"~"===a[c]||"'"===a[c])e.push(a[c]);else if(";"===a[c])for(;c!=a.length&&"\n"!==a[c];)c++;else if('"'===a[c]){for(var f=c+1;f!=a.length;)if("\\"===a[f])f+=2;else{if('"'===a[f])break;f++}e.push(a.slice(c,f+1));c=f}else{for(f=c+1;f!==a.length&&" "!==a[f]&&"\n"!==a[f]&&"\t"!==a[f]&&","!==a[f]&&")"!==a[f]&&"("!==a[f]&&"]"!==a[f]&&"["!==a[f]&&"{"!==a[f]&&"}"!==a[f]&&"'"!==a[f]&&"`"!==a[f]&&"~"!==a[f]&&";"!==a[f]&&":"!==a[f]&&"."!==a[f];)f+=1;var k=a.slice(c,f);if("."===k[0]&&")"===e[e.length-1]&&" "!==
a[c-1]&&"\n"!==a[c-1]&&"\t"!==a[c-1]){var g=1,d=e.length-1;e.push("");e.push("");e[d+2]=e[d];for(--d;;){e[d+2]=e[d];")"===e[d]&&g++;"("===e[d]&&g--;if(0===g)break;d--}e[d]="(";e[d+1]="get";e.push('"'+k.slice(1)+'"');e.push(")")}else"."===k[0]&&0<c&&" "!==a[c-1]&&"\t"!==a[c-1]&&"\n"!==a[c-1]&&"{"!==a[c-1]&&"("!==a[c-1]&&"}"!==a[c-1]&&")"!==a[c-1]?(c=e[e.length-1],e[e.length-1]="(",e.push("get"),e.push(c),e.push('"'+k.slice(1)+'"'),e.push(")")):"."===k[0]&&'"'===a[c-1]?e[e.length-1]+=k:e.push(k);c=
f-1}return 0!==b?null:e};q=function(a){var e={"'":"quote","~":"unquote","~@":"unquote-splice","`":"quasiquote"};if(null===a)return null;var b=null,c,f=null,k=null;for(c=a.length-1;0<=c;c--)")"===a[c]?(f=cons(b,f),b=null):"("===a[c]?(0===c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?b=cons(b,car(f)):(b=cons(cons(e[a[c-1]],cons(b,null)),car(f)),c--),f=cdr(f)):(k=a[c],0===c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?b=cons(k,b):(b=cons(cons(e[a[c-1]],cons(k,null)),b),c--));
return b};var x=function(a){if(null===a)return null;var e=a.first;return e instanceof $List?cons("cons",cons(x(e),cons(x(a.rest),null))):"string"===typeof e&&"."===e?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(e,null)),cons(x(cdr(a)),null)))},A=function(a){for(var e="",b=0;b<a.length;b++)var c=a.charCodeAt(b),e=47<c&&58>c||64<c&&91>c||96<c&&123>c||"$"===a[b]||"_"===a[b]||"."===a[b]||"&"===a[b]||255<c?e+a[b]:e+("_$"+c+"_");isNaN(e[0])||(e="_"+e);return e},w=function(a){if(null===
a)return null;v=a.first;return v instanceof $List?"string"===typeof v.first&&"unquote"===v.first?cons("cons",cons(v.rest.first,cons(w(cdr(a)),null))):"string"==typeof v.first&&"unquote-splice"===v.first?cons("append",cons(v.rest.first,cons(w(a.rest),null))):cons("cons",cons(w(v),cons(w(a.rest),null))):"string"===typeof v&&"."===v?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(v,null)),cons(w(a.rest),null)))},t=function(a,b,l){if(null===a&&null===b)return l;if(null===a&&null!==
b||null!==a&&null===b&&"."!==a.first)return 0;if(a.first instanceof $List&&b.first instanceof $List)return t(a.first,b.first,l)?t(a.rest,b.rest,l):0;if(a.first instanceof $List&&!(b.first instanceof $List))return 0;if("string"===typeof a.first&&"#"===a.first[0])return"string"!==typeof b.first?0:a.first.slice(1)===b.first?t(a.rest,b.rest,l):0;if("string"===typeof a.first&&"."===a.first)return l[a.rest.first]=b,l;l[a.first]=b.first;return t(a.rest,b.rest,l)},D=function(a,e){for(var l=function(a){if(null===
a)return null;if(a.first instanceof $List)return cons(cons("list",l(a.first)),l(a.rest));if('"'===a.first[0]){for(var b="",c=0;c<a.first.length;c++)b='"'===a.first[c]?b+'\\"':"\\"===a.first[c]?b+"\\\\":"\n"===a.first[c]?b+"\\n":"\t"===a.first[c]?b+"\\t":b+a.first[c];return cons('"'+b+'"',l(a.rest))}return null===a.first?cons(a.first,l(a.rest)):cons('"'+a.first+'"',l(a.rest))};null!==a;){var c=t(a.first,e,{});if(c){var f="(function(){",k;for(k in c)f=c[k]instanceof $List?f+("var "+k+" = "+b(cons("list",
l(c[k])))+"; "):null===c[k]?f+("var "+k+" = null; "):f+("var "+k+" = "+b('"'+c[k])+'"; ');f+="return ("+b(a.rest.first)+");";f+="})();";if(node_environment)try{return vm.runInContext(f,y,"lisp.vm")}catch(g){return console.log(g),""}else try{return window.eval(f)}catch(d){return console.log(d),""}}a=a.rest.rest}console.log("ERROR: Failed to expand macro\n");return""},B=function(a){for(var e="",l=!1;null!==a;){var c=a.first,c=b(c,null,null,null,!0);if("string"===typeof c&&":"===c[0])for(!1===l?(e+=
"(",l=!0):e+=", ",e+="{"+c.slice(1)+": "+b(a.rest.first,null,null,null,!0),a=a.rest.rest;;){if(null===a){e+="}";break}c=b(a.first,null,null,null,!0);if(":"!==c[0]){e+="}, "+c;break}if(null===a.rest)return console.log("ERROR: Invalid parameter name"),"";var f=b(a.rest.first,null,null,null,!0),e=e+(", "+c.slice(1)+": "+f);a=a.rest.rest}else!1===l?(e+="(",l=!0):e+=", ",e+=c;if(null===a||null===a.rest)break;a=a.rest}l&&(e+=")");return 0===e.trim().length?"()":e},C=function(a){if('"'===a[0]||"."==a[0]){var b=
"."===a[0]?a.slice(1):a.slice(1,-1);return b===A(b)&&isNaN(b)?"."+b:"["+a+"]"}return"["+a+"]"};b=function(a,e,l,c,f,k){if(null===a)return c?"return null":"null";if(a instanceof $List){var g=car(a),d,n,p,m;if("def"===g||"="===g||"set!"===g||"const"===g)return l=car(cdr(a)),n=null===cdr(cdr(a))?null:null!==cdr(cdr(cdr(a)))?cons("fn",cons(car(cdr(cdr(a))),cdr(cdr(cdr(a))))):a.rest.rest.first,l=b(l),n=b(n,null,null,null,!0,l),d=("def"===g?"var ":"const"===g?"const ":"")+l+" = "+n+" ",c?d+"; return "+
l:d;if("Array"===g){d=c?"return [":"[";for(a=cdr(a);null!==a;)d+=b(car(a),null,null,null,!0),null!==cdr(a)&&(d+=", "),a=cdr(a);return d+"]"}if("Object"===g){d=c?"return {":"{";for(a=a.rest;null!==a;){p=b(a.first,null,null,null,!0);if(":"===p[0])if(null!==a.rest&&":"!==a.rest.first[0])k=p.slice(1),k=A(k)===k&&isNaN(k)?k:'"'+k+'"',d+=k+": ";else{d+=p.slice(1)+(null===a.rest?"":", ");a=a.rest;continue}else d="'"===p[0]||'"'===p[0]?d+(p+": "):d+("["+p+"]: ");k=b(a.rest.first,null,null,null,!0);d+=k;null!==
a.rest.rest&&(d+=", ");a=a.rest.rest}return d+="}"}if("quote"===g||"quasiquote"===g)return a.rest.first instanceof $List?(f=b("quote"===g?x(a.rest.first):w(a.rest.first)),c?"return "+f:f):null===a.rest?c?"return null":"null":isNaN(a.rest.first)?c?'return "'+a.rest.first+'"':'"'+a.rest.first+'"':c?"return "+a.rest.first:a.rest.first;if("fn"===g||"fn*"===g){d="fn"===g?"function ":"function* ";c&&(d="return "+d);c="";"string"===typeof a.rest.first?(k=a.rest.first,c+=a.rest.first+"(",f=a.rest.rest.first,
a=a.rest.rest.rest):(c+="(",f=a.rest.first,a=a.rest.rest);e=[];for(var q={},g=0,t=!1,u=null;null!==f;)if(m=f.first,"string"!==typeof m){if("Object"!==m.first)return console.log("ERROR: Invalid parameters"),"";g++;for(m=m.rest;null!==m;)l=b(m.first),l='"'===l[0]?l.slice(1,-1):l,l=":"===l[0]?l.slice(1):l,n=b(m.rest.first,null,null,null,!0),q[l]=n,m=m.rest.rest;c+="__lisp_args__";f=f.rest;null!==f&&"&"!==f.first&&"."!==f.first&&(c+=", ");e.push(q)}else{m=b(m);if("&"===m){g++;u=b(f.rest.first);break}else if("."===
m){g++;f=f.rest;u=b(f.first);t=!0;break}else if(":"===m[0]){g++;l=m.slice(1);c+=l;e.push([l,b(f.rest.first,null,null,null,!0)]);f=f.rest.rest;null!==f&&"&"!==f.first&&"."!==f.first&&(c+=", ");continue}else g++,c+=m,null!==f.rest&&"&"!==f.rest.first&&"."!==f.rest.first&&(c+=", ");f=f.rest}l=[k?k:!1];c+="){";u&&(c+="for(var "+u+" = [], $__0 = "+(g-1)+"; $__0 < arguments.length; $__0++)"+u+"[$__0 - "+(g-1)+"] = arguments[$__0];",t&&(c+=u+" = list.apply(null, "+u+");"));for(n=0;n<e.length;n++)if(f=e[n],
f.constructor===Array)m=f[0],c+=m+" = ("+m+" === void 0 ? "+f[1]+" : "+m+" );";else for(p in c+="var __lisp_args_v__;",c+="__lisp_args__ = (__lisp_args__ === void 0 ? {} : __lisp_args__); ",f)c+="var "+p+" = ((__lisp_args_v__ = __lisp_args__."+p+") === void 0 ? "+f[p]+" : __lisp_args_v__); ";c+=r(a,!0,null,l);!1!==l[0]&&l[0]!==k&&(d+=l[0]);return d+(c+"}")}if("let"===g){k={};f=cdr(a);for(d="((function(){";null!==f.rest;)l=f.first,p=f.rest.first,typeof("string"===l)?l in k?d+=l+" = "+b(p)+"; ":(k[l]=
!0,d+="var "+l+" = "+b(p)+"; "):console.log("let implementation not finished yet"),f=f.rest.rest;d+=b(f.first,null,null,!0);d+="})())";return(c?"return ":"")+d}if("cond"===g){n=!1;e=a.rest;d="if(";f&&(d="(function(){"+d);p=b(e.first,null,null,null,!0,null);d=d+p+"){";a=e.rest.first;d+=b(a,!0,l,c||f,null,k);d+="}";for(e=e.rest.rest;null!==e;)if(d+=" else ","else"!==e.first)d+="if (",p=b(e.first),d=d+p+"){",a=e.rest.first,d+=b(a,!0,l,c||f,null,k),d+="}",e=e.rest.rest;else{n=!0;d+="{";a=e.rest.first;
d+=b(a,!0,l,c||f,null,k);d+="}";break}!1===n&&c&&(d+=" else return null");f&&(d+="})()");return d}if("if"===g)return d="(",p=a.rest.first,k=a.rest.rest.first,a=null===a.rest.rest.rest?null:a.rest.rest.rest.first,f?(d+=b(p)+" ? ",d+=b(k,e,l,null,!0,null)+" : ",d+=b(a,e,l,null,!0,null)+")"):null===a?b(list("cond",p,k),e,l,c,f):b(list("cond",p,k,"else",a),e,l,c,f);if("do"===g)return f?"(function (){"+r(a.rest,!0)+"})()":r(a.rest,c,null,l);if("apply"===g)return k=b(a.rest.first),f=b(a.rest.rest.first,
null,null,null,!0),(c?"return ":"")+"("+k+").apply(this, (function(){var temp = "+f+"; return temp instanceof $List ? temp.toArray() : temp})())";if("new"===g)return k=b(a.rest.first),d="(new "+k+""+B(a.rest.rest),d+=")",(c?"return ":"")+d;if("+"===g||"-"===g||"*"===g||"/"===g||"%"===g||"=="===g||"<"===g||">"===g||"!="===g||"<="===g||">="===g||"&&"===g||"||"===g||"&"===g||"|"===g||"and"===g||"or"===g){d="(";f=a.rest;if(null===f.rest)return"+"===g||"*"===g||"%"===g?(c?"return ":"")+b(f.first,null,
null,null,!0):"-"===g?(c?"return ":"")+"(-"+b(f.first,null,null,null,!0)+")":"/"===g?(c?"return ":"")+"(1/"+b(f.first,null,null,null,!0)+")":(c?"return ":"")+"true";m=b(f.first,null,null,null,!0);d+=m;for(f=f.rest;null!==f;)m=b(f.first,null,null,null,!0),"and"===g?g="&&":"or"===g?g="||":"=="==g&&(g="==="),d+=" "+g+" ",d+=m,null===f.rest||"==="!==g&&"<"!==g&&">"!==g&&"!="!==g&&"<="!==g&&">="!==g||(d+=" && "+m),f=f.rest;return(c?"return ":"")+d+")"}if("not"===g)return(c?"return ":"")+"(!"+b(a.rest.first,
null,null,null,!0)+")";if("instanceof"===g)return(c?"return ":"")+"("+b(a.rest.first)+" instanceof "+b(a.rest.rest.first)+")";if("get"===g){d=f=b(a.rest.first,null,null,null,!0);for(k=a.rest.rest;null!==k;)p=b(k.first,null,null,null,!0),d+=C(p),k=k.rest;return(c?"return ":"")+d}if("->"===g){d=f=b(a.rest.first,null,null,null,!0);for(k=a.rest.rest;null!==k;)l=!1,k.first instanceof $List?(l=!0,p=b(k.first.first,null,null,null,!0)):p=b(k.first,null,null,null,!0),d+=C(p),l&&(f=k.first.rest,d+=B(f)),k=
k.rest;return(c?"return ":"")+d}if("try"===g)return e=a.rest,a=e.first,d="try{"+b(a,!0,l,c||f,null,k),d+="}",e=e.rest,null!==e&&"catch"===e.first&&(d+="catch(",p=b(e.rest.first),d+=p+"){",a=e.rest.rest.first,d+=b(a,!0,l,c||f,null,k),d+="}",e=e.rest.rest.rest),null!==e&&"finally"===e.first&&(a=e.rest.first,d+="finally {",d+=b(a,!0,l,c||f,null,k),d+="}"),d;if("throw"===g||"yield"===g)return g+" "+b(a.rest.first,null,null,null,!0)+(c?"; return;":"");if("in"===g)return(c?"return ":"")+"("+b(a.rest.first)+
" in "+b(a.rest.rest.first)+")";if("defmacro"===g){d=b(a.rest.first);if("string"!=typeof d)return console.log("ERROR: Invalid macro name: "+d.toString()),"";e=a.rest.rest;h[d]=e;return""}k=a.first;f=a.rest;k=b(k);"recur"===k&&e&&(!1===l[0]&&(l[0]="__lisp__recur__$"+s,s+=3),k=l[0],a.first=k);d=k;"}"!==k[k.length-1]&&isNaN(k)||(d="("+d+")");if(k in h)return d=D(h[k],f),(c?"return ":"")+b(d);d+=B(f);return(c?"return ":"")+d}return isNaN(a)&&"'"!==a[0]&&'"'!==a[0]&&":"!==a[0]?(c?"return ":"")+A(a):(c?
"return ":"")+a};r=function(a,e,l,c,f){for(var k="",g,d=!1;null!==a;){e&&null===a.rest&&(d=!0);g=b(a.first,null===a.rest?!0:!1,c,d);"string"===typeof g&&(g=g.trim());"string"===typeof g&&0!==g.length&&";"!==g[g.length-1]&&(g+="; ");if(l)if(node_environment)try{n=vm.runInContext(g,y,"lisp.vm"),f&&console.log(n)}catch(h){console.log(h)}else try{n=window.eval(g),f&&console.log(n)}catch(m){console.log(m)}k+=g;a=a.rest}return k};return{lexer:m,parser:q,compiler:b,lisp_compiler:r,compile:function(a,b){var h=
m(a);if(null===h)return null;h=q(h);return r(h,!1,!0,null,b)},getEvalResult:function(){return n}}},lisp=lisp_module();"undefined"!==typeof module&&(module.exports.compile=lisp.compile,module.exports.getEvalResult=lisp.getEvalResult);
