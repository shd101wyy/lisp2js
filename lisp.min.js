var node_environment=!1,vm=null;"undefined"!=typeof module&&(vm=require("vm"),node_environment=!0);var $List,car,cdr,cons,list,list_module,__slice=[].slice;
list_module=function(){var n,q,b;n=function(b,k){this.first=b;this.rest=k;return null};n.prototype.length=function(){var b;b=function(k,l){return null===k?l:b(k.rest,l+1)};return b(this,0)};n.prototype.toString=function(){var b;b=function(k,l){return null===k?l+")":k instanceof n?b(k.rest,l+(null===k.first?"()":k.first.toString())+(null===k.rest?"":", ")):l.slice(0,-2)+" . "+k.toString()+")"};return b(this,"(")};n.prototype.reverse=function(){var b;b=function(k,l){return k instanceof n?b(k.rest,q(k.first,
l)):null===k?l:q(k,l)};return b(this,null)};n.prototype.slice=function(b,k){var l,n,s;null==k&&(k=null);if(null===k)return 0>b&&(b=this.length()+b),n=function(b,k){return 0===k?b:n(b.rest,k-1)},n(this,b);if(0>b||0>k)l=this.length(),b=0>b?l+b:b,k=0>k?l+k:k;s=function(b,k,l){return 0===k?0===l||null===b?null:q(b.first,s(b.rest,k,l-1)):s(b.rest,k-1,l)};return s(this,b,k-b)};n.prototype.ref=function(b){var k;0>b&&(b=this.length()+b);k=function(b,r){return null===b?null:0===r?b.first:k(b.rest,r-1)};return k(this,
b)};n.prototype.append=function(){var r,k;k=1<=arguments.length?__slice.call(arguments,0):[];k=b.apply(b,k);r=function(b,k){return null===b?k:q(b.first,r(b.rest,k))};return r(this,k)};n.prototype.toArray=function(){var b,k;b=[];k=function(l){if(null===l)return b;b.push(l.first);return k(l.rest)};return k(this)};n.prototype.forEach=function(b){var k;k=function(l){if(null===l)return null;b(l.first);return k(l.rest)};return k(this)};n.prototype.foreach=n.prototype.forEach;n.prototype.map=function(b){var k;
k=function(l){return null===l?null:q(b(l.first),k(l.rest))};return k(this)};n.prototype.filter=function(b){var k;k=function(l){return null===l?null:b(l.first)?q(l.first,k(l.rest)):k(l.rest)};return k(this)};q=function(b,k){return new n(b,k)};b=function(){var b,k;b=1<=arguments.length?__slice.call(arguments,0):[];k=function(b,n){return n===b.length?null:q(b[n],k(b,n+1))};return k(b,0)};return{list:b,cons:q,List:n,car:function(b){return b.first},cdr:function(b){return b.rest}}}();$List=list_module.List;
list=list_module.list;cons=list_module.cons;car=list_module.car;cdr=list_module.cdr;"undefined"!==typeof module&&(module.exports.$List=$List,module.exports.list=list,module.exports.cons=cons,module.exports.car=car,module.exports.cdr=cdr);
var lisp_module=function(){var n,q,b,r,k={},l="",z=null,s=0,A=function(a,h){return null===a?h instanceof $List||null===h?h:cons(h,null):cons(a.first,A(a.rest,h))};node_environment?z=vm.createContext({cons:cons,car:car,cdr:cdr,list:list,$List:$List,append:A,console:console}):window.append=A;n=function(a){for(var h=[],b=0,c=0;c<a.length;c++)if("("===a[c])h.push("("),b++;else if("["===a[c]){if(0!==c&&" "!==a[c-1]&&"\n"!==a[c-1]&&"\t"!==a[c-1]&&"'"!==a[c-1]&&"`"!==a[c-1]&&"~"!==a[c-1]&&"("!==a[c-1]&&
"{"!==a[c-1]&&"["!==a[c-1])if(d=h.length-1,g=")"===h[d]?1:0,0===g)h.push("get"),h.push(h[d]),h[d]="(";else{h.push("");h.push("");h[d+2]=h[d];for(--d;;){h[d+2]=h[d];")"===h[d]&&g++;"("===h[d]&&g--;if(0===g)break;d--}h[d]="(";h[d+1]="get"}else h.push("("),h.push("Array");b++}else if("{"===a[c])h.push("("),h.push("Object"),b++;else if(")"===a[c]||"]"===a[c]||"}"===a[c])h.push(")"),b--;else if(" "!==a[c]&&"\n"!==a[c]&&"\t"!=a[c]&&","!=a[c])if("~"===a[c]&&"@"===a[c+1])h.push("~@"),c++;else if("`"===a[c]||
"~"===a[c]||"'"===a[c])h.push(a[c]);else if(";"===a[c])for(;c!=a.length&&"\n"!==a[c];)c++;else if('"'===a[c]){for(var e=c+1;e!=a.length;)if("\\"===a[e])e+=2;else{if('"'===a[e])break;e++}h.push(a.slice(c,e+1));c=e}else{for(e=c+1;e!==a.length&&" "!==a[e]&&"\n"!==a[e]&&"\t"!==a[e]&&","!==a[e]&&")"!==a[e]&&"("!==a[e]&&"]"!==a[e]&&"["!==a[e]&&"{"!==a[e]&&"}"!==a[e]&&"'"!==a[e]&&"`"!==a[e]&&"~"!==a[e]&&";"!==a[e]&&":"!==a[e]&&"."!==a[e];)e+=1;var k=a.slice(c,e);if("."===k[0]&&")"===h[h.length-1]&&" "!==
a[c-1]&&"\n"!==a[c-1]&&"\t"!==a[c-1]){var g=1,d=h.length-1;h.push("");h.push("");h[d+2]=h[d];for(--d;;){h[d+2]=h[d];")"===h[d]&&g++;"("===h[d]&&g--;if(0===g)break;d--}h[d]="(";h[d+1]="get";h.push('"'+k.slice(1)+'"');h.push(")")}else"."===k[0]&&0<c&&" "!==a[c-1]&&"\t"!==a[c-1]&&"\n"!==a[c-1]&&"{"!==a[c-1]&&"("!==a[c-1]&&"}"!==a[c-1]&&")"!==a[c-1]?(c=h[h.length-1],h[h.length-1]="(",h.push("get"),h.push(c),h.push('"'+k.slice(1)+'"'),h.push(")")):"."===k[0]&&'"'===a[c-1]?h[h.length-1]+=k:h.push(k);c=
e-1}return 0!==b?null:h};q=function(a){var b={"'":"quote","~":"unquote","~@":"unquote-splice","`":"quasiquote"};if(null===a)return null;var f=null,c,e=null,k=null;for(c=a.length-1;0<=c;c--)")"===a[c]?(e=cons(f,e),f=null):"("===a[c]?(0===c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?f=cons(f,car(e)):(f=cons(cons(b[a[c-1]],cons(f,null)),car(e)),c--),e=cdr(e)):(k=a[c],0===c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?f=cons(k,f):(f=cons(cons(b[a[c-1]],cons(k,null)),f),c--));
return f};var y=function(a){if(null===a)return null;var b=a.first;return b instanceof $List?cons("cons",cons(y(b),cons(y(a.rest),null))):"string"===typeof b&&"."===b?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(b,null)),cons(y(cdr(a)),null)))},B=function(a){for(var b="",f=0;f<a.length;f++)var c=a.charCodeAt(f),b=47<c&&58>c||64<c&&91>c||96<c&&123>c||"$"===a[f]||"_"===a[f]||"."===a[f]||"&"===a[f]||255<c?b+a[f]:b+("_$"+c+"_");isNaN(b[0])||(b="_"+b);return b},u=function(a){if(null===
a)return null;v=a.first;return v instanceof $List?"string"===typeof v.first&&"unquote"===v.first?cons("cons",cons(v.rest.first,cons(u(cdr(a)),null))):"string"==typeof v.first&&"unquote-splice"===v.first?cons("append",cons(v.rest.first,cons(u(a.rest),null))):cons("cons",cons(u(v),cons(u(a.rest),null))):"string"===typeof v&&"."===v?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(v,null)),cons(u(a.rest),null)))},x=function(a,b,f){if(null===a&&null===b)return f;if(null===a&&null!==
b||null!==a&&null===b&&"."!==a.first)return 0;if(a.first instanceof $List&&b.first instanceof $List)return x(a.first,b.first,f)?x(a.rest,b.rest,f):0;if(a.first instanceof $List&&!(b.first instanceof $List))return 0;if("string"===typeof a.first&&"#"===a.first[0])return"string"!==typeof b.first?0:a.first.slice(1)===b.first?x(a.rest,b.rest,f):0;if("string"===typeof a.first&&"."===a.first)return f[a.rest.first]=b,f;f[a.first]=b.first;return x(a.rest,b.rest,f)},E=function(a,h){for(var f=function(a){if(null===
a)return null;if(a.first instanceof $List)return cons(cons("list",f(a.first)),f(a.rest));if('"'===a.first[0]){for(var c="",b=0;b<a.first.length;b++)c='"'===a.first[b]?c+'\\"':"\\"===a.first[b]?c+"\\\\":"\n"===a.first[b]?c+"\\n":"\t"===a.first[b]?c+"\\t":c+a.first[b];return cons('"'+c+'"',f(a.rest))}return null===a.first?cons(a.first,f(a.rest)):cons('"'+a.first+'"',f(a.rest))};null!==a;){var c=x(a.first,h,{});if(c){var e="(function(){",k;for(k in c)e=c[k]instanceof $List?e+("var "+k+" = "+b(cons("list",
f(c[k])))+"; "):null===c[k]?e+("var "+k+" = null; "):e+("var "+k+" = "+b('"'+c[k])+'"; ');e+="return ("+b(a.rest.first)+");";e+="})();";if(node_environment)try{return vm.runInContext(e,z,"lisp.vm")}catch(g){return console.log(g),""}else try{return window.eval(e)}catch(d){return console.log(d),""}}a=a.rest.rest}console.log("ERROR: Failed to expand macro\n");return""},C=function(a){for(var h="",f=!1;null!==a;){var c=a.first,c=b(c,null,null,null,!0);if("string"===typeof c&&":"===c[0])for(!1===f?(h+=
"(",f=!0):h+=", ",h+="{"+c.slice(1)+": "+b(a.rest.first,null,null,null,!0),a=a.rest.rest;;){if(null===a){h+="}";break}c=b(a.first,null,null,null,!0);if(":"!==c[0]){h+="}, "+c;break}if(null===a.rest)return console.log("ERROR: Invalid parameter name"),"";var e=b(a.rest.first,null,null,null,!0),h=h+(", "+c.slice(1)+": "+e);a=a.rest.rest}else!1===f?(h+="(",f=!0):h+=", ",h+=c;if(null===a||null===a.rest)break;a=a.rest}f&&(h+=")");return 0===h.trim().length?"()":h},D=function(a){if('"'===a[0]||"."==a[0]){var b=
"."===a[0]?a.slice(1):a.slice(1,-1);return b===B(b)&&isNaN(b)?"."+b:"["+a+"]"}return"["+a+"]"};b=function(a,h,f,c,e,l){if(null===a)return c?"return null":"null";if(a instanceof $List){var g=car(a),d,p,n,m;if("def"===g||"="===g||"set!"===g||"const"===g)return p=car(cdr(a)),n=null===cdr(cdr(a))?null:null!==cdr(cdr(cdr(a)))?cons("fn",cons(car(cdr(cdr(a))),cdr(cdr(cdr(a))))):a.rest.rest.first,p=b(p),n=b(n,null,null,null,!0,p),d=("def"===g?"var ":"const"===g?"const ":"")+p+" = "+n+" ",c?d+"; return "+
p:d;if("Array"===g){d=c?"return [":"[";for(a=cdr(a);null!==a;)d+=b(car(a),null,null,null,!0),null!==cdr(a)&&(d+=", "),a=cdr(a);return d+"]"}if("Object"===g){d=c?"return {":"{";for(a=a.rest;null!==a;){m=b(a.first,null,null,null,!0);if(":"===m[0])if(null!==a.rest&&":"!==a.rest.first[0])f=m.slice(1),f=B(f)===f&&isNaN(f)?f:'"'+f+'"',d+=f+": ";else{d+=m.slice(1)+(null===a.rest?"":", ");a=a.rest;continue}else d="'"===m[0]||'"'===m[0]?d+(m+": "):d+("["+m+"]: ");f=b(a.rest.first,null,null,null,!0);d+=f;null!==
a.rest.rest&&(d+=", ");a=a.rest.rest}return d+="}"}if("quote"===g||"quasiquote"===g)return a.rest.first instanceof $List?(e=b("quote"===g?y(a.rest.first):u(a.rest.first)),c?"return "+e:e):null===a.rest?c?"return null":"null":isNaN(a.rest.first)?c?'return "'+a.rest.first+'"':'"'+a.rest.first+'"':c?"return "+a.rest.first:a.rest.first;if("fn"===g||"fn*"===g||"\u03bb"===g||"\u03bb*"===g){d="fn"===g||"\u03bb"===g?"function ":"function* ";c&&(d="return "+d);c="";"string"===typeof a.rest.first?(l=a.rest.first,
c+=a.rest.first+"(",e=a.rest.rest.first,a=a.rest.rest.rest):(c+="(",e=a.rest.first,a=a.rest.rest);h=[];for(var q={},g=0,w=!1,t=null;null!==e;)if(f=e.first,"string"!==typeof f){if("Object"!==f.first)return console.log("ERROR: Invalid parameters"),"";g++;for(f=f.rest;null!==f;)p=b(f.first),p='"'===p[0]?p.slice(1,-1):p,p=":"===p[0]?p.slice(1):p,n=b(f.rest.first,null,null,null,!0),q[p]=n,f=f.rest.rest;c+="__lisp_args__";e=e.rest;null!==e&&"&"!==e.first&&"."!==e.first&&(c+=", ");h.push(q)}else{f=b(f);
if("&"===f){g++;t=b(e.rest.first);break}else if("."===f){g++;e=e.rest;t=b(e.first);w=!0;break}else if(":"===f[0]){g++;f=f.slice(1);c+=f;h.push([f,b(e.rest.first,null,null,null,!0)]);e=e.rest.rest;null!==e&&"&"!==e.first&&"."!==e.first&&(c+=", ");continue}else g++,c+=f,null!==e.rest&&"&"!==e.rest.first&&"."!==e.rest.first&&(c+=", ");e=e.rest}f=[l?l:!1];c+="){";t&&(c+="for(var "+t+" = [], $__0 = "+(g-1)+"; $__0 < arguments.length; $__0++)"+t+"[$__0 - "+(g-1)+"] = arguments[$__0];",w&&(c+=t+" = list.apply(null, "+
t+");"));for(p=0;p<h.length;p++)if(e=h[p],e.constructor===Array)n=e[0],c+=n+" = ("+n+" === void 0 ? "+e[1]+" : "+n+" );";else for(m in c+="var __lisp_args_v__;",c+="__lisp_args__ = (__lisp_args__ === void 0 ? {} : __lisp_args__); ",e)c+="var "+m+" = ((__lisp_args_v__ = __lisp_args__."+m+") === void 0 ? "+e[m]+" : __lisp_args_v__); ";c+=r(a,!0,null,f);!1!==f[0]&&f[0]!==l&&(d+=f[0]);return d+(c+"}")}if("let"===g){f={};e=cdr(a);for(d="((function(){";null!==e.rest;)p=e.first,l=e.rest.first,typeof("string"===
p)?p in f?d+=p+" = "+b(l)+"; ":(f[p]=!0,d+="var "+p+" = "+b(l)+"; "):console.log("let implementation not finished yet"),e=e.rest.rest;d+=b(e.first,null,null,!0);d+="})())";return(c?"return ":"")+d}if("cond"===g){h=!1;m=a.rest;d="if(";e&&(d="(function(){"+d);p=b(m.first,null,null,null,!0,null);d=d+p+"){";a=m.rest.first;d+=b(a,!0,f,c||e,null,l);d+="}";for(m=m.rest.rest;null!==m;)if(d+=" else ","else"!==m.first)d+="if (",p=b(m.first),d=d+p+"){",a=m.rest.first,d+=b(a,!0,f,c||e,null,l),d+="}",m=m.rest.rest;
else{h=!0;d+="{";a=m.rest.first;d+=b(a,!0,f,c||e,null,l);d+="}";break}!1===h&&c&&(d+=" else return null");e&&(d+="})()");return d}if("if"===g)return d="(",p=a.rest.first,l=a.rest.rest.first,m=null===a.rest.rest.rest?null:a.rest.rest.rest.first,e?(d+=b(p)+" ? ",d+=b(l,h,f,null,!0,null)+" : ",d+=b(m,h,f,null,!0,null)+")"):null===m?b(list("cond",p,l),h,f,c,e):b(list("cond",p,l,"else",m),h,f,c,e);if("do"===g)return e?"(function (){"+r(a.rest,!0)+"})()":r(a.rest,c,null,f);if("apply"===g)return l=b(a.rest.first),
e=b(a.rest.rest.first,null,null,null,!0),(c?"return ":"")+"("+l+").apply(this, (function(){var temp = "+e+"; return temp instanceof $List ? temp.toArray() : temp})())";if("new"===g)return l=b(a.rest.first),d="(new "+l+""+C(a.rest.rest),d+=")",(c?"return ":"")+d;if("+"===g||"-"===g||"*"===g||"/"===g||"%"===g||"=="===g||"<"===g||">"===g||"!="===g||"<="===g||">="===g||"&&"===g||"||"===g||"&"===g||"|"===g||"and"===g||"or"===g){d="(";e=a.rest;if(null===e.rest)return"+"===g||"*"===g||"%"===g?(c?"return ":
"")+b(e.first,null,null,null,!0):"-"===g?(c?"return ":"")+"(-"+b(e.first,null,null,null,!0)+")":"/"===g?(c?"return ":"")+"(1/"+b(e.first,null,null,null,!0)+")":(c?"return ":"")+"true";f=b(e.first,null,null,null,!0);d+=f;for(e=e.rest;null!==e;)f=b(e.first,null,null,null,!0),"and"===g?g="&&":"or"===g?g="||":"=="==g&&(g="==="),d+=" "+g+" ",d+=f,null===e.rest||"==="!==g&&"<"!==g&&">"!==g&&"!="!==g&&"<="!==g&&">="!==g||(d+=" && "+f),e=e.rest;return(c?"return ":"")+d+")"}if("not"===g)return(c?"return ":
"")+"(!"+b(a.rest.first,null,null,null,!0)+")";if("instanceof"===g)return(c?"return ":"")+"("+b(a.rest.first)+" instanceof "+b(a.rest.rest.first)+")";if("get"===g){d=e=b(a.rest.first,null,null,null,!0);for(f=a.rest.rest;null!==f;)m=b(f.first,null,null,null,!0),d+=D(m),f=f.rest;return(c?"return ":"")+d}if("->"===g){d=e=b(a.rest.first,null,null,null,!0);for(f=a.rest.rest;null!==f;)l=!1,f.first instanceof $List?(l=!0,m=b(f.first.first,null,null,null,!0)):m=b(f.first,null,null,null,!0),d+=D(m),l&&(e=
f.first.rest,d+=C(e)),f=f.rest;return(c?"return ":"")+d}if("loop"===g){d=[];g=[];for(m=a.rest;null!==m.rest;)p=b(m.first),n=b(m.rest.first,null,null,null,!0),d.push(p),g.push(n),m=m.rest.rest;w=n=null;for(p=d.length-1;0<=p;p--)n=cons(d[p],n),w=cons(g[p],w);a=m.first;return b(cons(list("fn",n,a),w),h,f,c,e,l)}if("try"===g)return m=a.rest,a=m.first,d="try{"+b(a,!0,f,c||e,null,l),d+="}",m=m.rest,null!==m&&"catch"===m.first&&(d+="catch(",a=b(m.rest.first),d+=a+"){",a=m.rest.rest.first,d+=b(a,!0,f,c||
e,null,l),d+="}",m=m.rest.rest.rest),null!==m&&"finally"===m.first&&(a=m.rest.first,d+="finally {",d+=b(a,!0,f,c||e,null,l),d+="}"),d;if("throw"===g||"yield"===g)return g+" "+b(a.rest.first,null,null,null,!0)+(c?"; return;":"");if("in"===g)return(c?"return ":"")+"("+b(a.rest.first)+" in "+b(a.rest.rest.first)+")";if("defmacro"===g){d=b(a.rest.first);if("string"!=typeof d)return console.log("ERROR: Invalid macro name: "+d.toString()),"";m=a.rest.rest;k[d]=m;return""}l=a.first;e=a.rest;l=b(l);"recur"===
l&&h&&(!1===f[0]&&(f[0]="__lisp__recur__$"+s,s+=3),l=f[0],a.first=l);d=l;"}"!==l[l.length-1]&&isNaN(l)||(d="("+d+")");if(l in k)return d=E(k[l],e),(c?"return ":"")+b(d);d+=C(e);return(c?"return ":"")+d}return isNaN(a)&&"'"!==a[0]&&'"'!==a[0]&&":"!==a[0]?(c?"return ":"")+B(a):(c?"return ":"")+a};r=function(a,h,f,c,e){for(var k="",g,d=!1;null!==a;){h&&null===a.rest&&(d=!0);g=b(a.first,null===a.rest?!0:!1,c,d);"string"===typeof g&&(g=g.trim());"string"===typeof g&&0!==g.length&&";"!==g[g.length-1]&&
(g+="; ");if(f)if(node_environment)try{l=vm.runInContext(g,z,"lisp.vm"),e&&console.log(l)}catch(n){console.log(n)}else try{l=window.eval(g),e&&console.log(l)}catch(q){console.log(q)}k+=g;a=a.rest}return k};return{lexer:n,parser:q,compiler:b,lisp_compiler:r,compile:function(a,b){var f=n(a);if(null===f)return null;f=q(f);return r(f,!1,!0,null,b)},getEvalResult:function(){return l}}},lisp=lisp_module();"undefined"!==typeof module&&(module.exports.compile=lisp.compile,module.exports.getEvalResult=lisp.getEvalResult);
