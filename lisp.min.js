var node_environment=!1,vm=null;"undefined"!=typeof module&&(vm=require("vm"),node_environment=!0);var $List,car,cdr,cons,list,list_module,__slice=[].slice;
list_module=function(){var m,q,b;m=function(b,d){this.first=b;this.rest=d;return null};m.prototype.length=function(){var b;b=function(d,n){return null===d?n:b(d.rest,n+1)};return b(this,0)};m.prototype.toString=function(){var b;b=function(d,n){return null===d?n+")":d instanceof m?b(d.rest,n+(null===d.first?"()":d.first.toString())+(null===d.rest?"":", ")):n.slice(0,-2)+" . "+d.toString()+")"};return b(this,"(")};m.prototype.reverse=function(){var b;b=function(d,n){return d instanceof m?b(d.rest,q(d.first,
n)):null===d?n:q(d,n)};return b(this,null)};m.prototype.slice=function(b,d){var n,m,s;null==d&&(d=null);if(null===d)return 0>b&&(b=this.length()+b),m=function(b,d){return 0===d?b:m(b.rest,d-1)},m(this,b);if(0>b||0>d)n=this.length(),b=0>b?n+b:b,d=0>d?n+d:d;s=function(b,d,n){return 0===d?0===n||null===b?null:q(b.first,s(b.rest,d,n-1)):s(b.rest,d-1,n)};return s(this,b,d-b)};m.prototype.ref=function(b){var d;0>b&&(b=this.length()+b);d=function(b,r){return null===b?null:0===r?b.first:d(b.rest,r-1)};return d(this,
b)};m.prototype.append=function(){var r,d;d=1<=arguments.length?__slice.call(arguments,0):[];d=b.apply(b,d);r=function(b,d){return null===b?d:q(b.first,r(b.rest,d))};return r(this,d)};m.prototype.toArray=function(){var b,d;b=[];d=function(n){if(null===n)return b;b.push(n.first);return d(n.rest)};return d(this)};m.prototype.forEach=function(b){var d;d=function(n){if(null===n)return null;b(n.first);return d(n.rest)};return d(this)};m.prototype.foreach=m.prototype.forEach;m.prototype.map=function(b){var d;
d=function(n){return null===n?null:q(b(n.first),d(n.rest))};return d(this)};m.prototype.filter=function(b){var d;d=function(n){return null===n?null:b(n.first)?q(n.first,d(n.rest)):d(n.rest)};return d(this)};q=function(b,d){return new m(b,d)};b=function(){var b,d;b=1<=arguments.length?__slice.call(arguments,0):[];d=function(b,m){return m===b.length?null:q(b[m],d(b,m+1))};return d(b,0)};return{list:b,cons:q,List:m,car:function(b){return b.first},cdr:function(b){return b.rest}}}();$List=list_module.List;
list=list_module.list;cons=list_module.cons;car=list_module.car;cdr=list_module.cdr;"undefined"!==typeof module&&(module.exports.$List=$List,module.exports.list=list,module.exports.cons=cons,module.exports.car=car,module.exports.cdr=cdr);
var lisp_module=function(){var m,q,b,r,d={},n="",y=null,s=0,z=function(a,g){return null===a?g instanceof $List||null===g?g:cons(g,null):cons(a.first,z(a.rest,g))};node_environment?y=vm.createContext({cons:cons,car:car,cdr:cdr,list:list,$List:$List,append:z,console:console}):window.append=z;m=function(a){for(var g=[],b=0,c=0;c<a.length;c++)if("("===a[c])g.push("("),b++;else if("["===a[c]){if(0!=c&&" "!==a[c-1]&&"\n"!==a[c-1]&&"\t"!==a[c-1]&&"'"!==a[c-1]&&"`"!==a[c-1]&&"~"!==a[c-1]&&"("!==a[c-1]&&"{"!==
a[c-1]&&"["!==a[c-1])if(d=g.length-1,h=")"===g[d]?1:0,0==h)g.push("get"),g.push(g[d]),g[d]="(";else{g.push("");g.push("");g[d+2]=g[d];for(--d;;){g[d+2]=g[d];")"===g[d]&&h++;"("===g[d]&&h--;if(0==h)break;d--}g[d]="(";g[d+1]="get"}else g.push("("),g.push("Array");b++}else if("{"===a[c])g.push("("),g.push("Object"),b++;else if(")"===a[c]||"]"===a[c]||"}"===a[c])g.push(")"),b--;else if(" "!==a[c]&&"\n"!==a[c]&&"\t"!=a[c]&&","!=a[c])if("~"===a[c]&&"@"===a[c+1])g.push("~@"),c++;else if("`"===a[c]||"~"===
a[c]||"'"===a[c])g.push(a[c]);else if(";"===a[c])for(;c!=a.length&&"\n"!==a[c];)c++;else if('"'===a[c]){for(var f=c+1;f!=a.length;)if("\\"===a[f])f+=2;else{if('"'===a[f])break;f++}g.push(a.slice(c,f+1));c=f}else{for(f=c+1;f!==a.length&&" "!==a[f]&&"\n"!==a[f]&&"\t"!==a[f]&&","!==a[f]&&")"!==a[f]&&"("!==a[f]&&"]"!==a[f]&&"["!==a[f]&&"{"!==a[f]&&"}"!==a[f]&&"'"!==a[f]&&"`"!==a[f]&&"~"!==a[f]&&";"!==a[f]&&":"!==a[f]&&"."!==a[f];)f+=1;var k=a.slice(c,f);if("."===k[0]&&")"===g[g.length-1]){var h=1,d=g.length-
1;g.push("");g.push("");g[d+2]=g[d];for(--d;;){g[d+2]=g[d];")"===g[d]&&h++;"("===g[d]&&h--;if(0==h)break;d--}g[d]="(";g[d+1]="get";g.push('"'+k.slice(1)+'"');g.push(")")}else"."===k[0]&&0<c&&" "!==a[c-1]&&"\t"!==a[c-1]&&"\n"!==a[c-1]&&"{"!==a[c-1]&&"("!==a[c-1]&&"}"!==a[c-1]&&")"!==a[c-1]?(c=g[g.length-1],g[g.length-1]="(",g.push("get"),g.push(c),g.push('"'+k.slice(1)+'"'),g.push(")")):"."===k[0]&&'"'===a[c-1]?g[g.length-1]+=k:g.push(k);c=f-1}return 0!=b?null:g};q=function(a){var g={"'":"quote","~":"unquote",
"~@":"unquote-splice","`":"quasiquote"};if(null===a)return null;var b=null,c,f=null,d=null;for(c=a.length-1;0<=c;c--)")"===a[c]?(f=cons(b,f),b=null):"("===a[c]?(0==c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?b=cons(b,car(f)):(b=cons(cons(g[a[c-1]],cons(b,null)),car(f)),c--),f=cdr(f)):(d=a[c],0==c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?b=cons(d,b):(b=cons(cons(g[a[c-1]],cons(d,null)),b),c--));return b};var x=function(a){if(null==a)return null;var b=a.first;return b instanceof
$List?cons("cons",cons(x(b),cons(x(a.rest),null))):"string"===typeof b&&"."===b?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(b,null)),cons(x(cdr(a)),null)))},A=function(a){for(var b="",d=0;d<a.length;d++)var c=a.charCodeAt(d),b=47<c&&58>c||64<c&&91>c||96<c&&123>c||"$"===a[d]||"_"===a[d]||"."===a[d]||"&"===a[d]||255<c?b+a[d]:b+("_$"+c+"_");isNaN(b[0])||(b="_"+b);return b},w=function(a){if(null==a)return null;v=a.first;return v instanceof $List?"string"===typeof v.first&&
"unquote"===v.first?cons("cons",cons(v.rest.first,cons(w(cdr(a)),null))):"string"==typeof v.first&&"unquote-splice"===v.first?cons("append",cons(v.rest.first,cons(w(a.rest),null))):cons("cons",cons(w(v),cons(w(a.rest),null))):"string"===typeof v&&"."===v?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(v,null)),cons(w(a.rest),null)))},t=function(a,b,d){if(null===a&&null===b)return d;if(null===a&&null!==b||null!==a&&null===b&&"."!==a.first)return 0;if(a.first instanceof $List&&
b.first instanceof $List)return t(a.first,b.first,d)?t(a.rest,b.rest,d):0;if(a.first instanceof $List&&!(b.first instanceof $List))return 0;if("string"===typeof a.first&&"#"===a.first[0])return"string"!==typeof b.first?0:a.first.slice(1)===b.first?t(a.rest,b.rest,d):0;if("string"===typeof a.first&&"."===a.first)return d[a.rest.first]=b,d;d[a.first]=b.first;return t(a.rest,b.rest,d)},C=function(a,d){for(var l=function(a){if(null===a)return null;if(a.first instanceof $List)return cons(cons("list",l(a.first)),
l(a.rest));if('"'===a.first[0]){for(var b="",c=0;c<a.first.length;c++)b='"'===a.first[c]?b+'\\"':"\\"===a.first[c]?b+"\\\\":"\n"===a.first[c]?b+"\\n":"\t"===a.first[c]?b+"\\t":b+a.first[c];return cons('"'+b+'"',l(a.rest))}return null===a.first?cons(a.first,l(a.rest)):cons('"'+a.first+'"',l(a.rest))};null!=a;){var c=t(a.first,d,{});if(c){var f="(function(){";for(key in c)f=c[key]instanceof $List?f+("var "+key+" = "+b(cons("list",l(c[key])))+"; "):null===c[key]?f+("var "+key+" = null; "):f+("var "+
key+" = "+b('"'+c[key])+'"; ');f+="return ("+b(a.rest.first)+");";f+="})();";if(node_environment)try{return vm.runInContext(f,y,"lisp.vm")}catch(k){return console.log(k),""}else try{return window.eval(f)}catch(h){return console.log(h),""}}a=a.rest.rest}console.log("ERROR: Failed to expand macro\n");return""},B=function(a){for(var d="(";null!=a;){var l=a.first,l=b(l,null,null,null,!0);if("string"===typeof l&&":"===l[0]){d+="{"+l.slice(1)+": "+b(a.rest.first,null,null,null,!0);for(a=a.rest.rest;;){if(null===
a){d+="}";break}l=b(a.first,null,null,null,!0);if(":"!==l[0]){d+="}, "+l;break}if(null===a.rest)return console.log("ERROR: Invalid parameter name"),"";var c=b(a.rest.first,null,null,null,!0),d=d+(", "+l.slice(1)+": "+c);a=a.rest.rest}null!==a&&null!==a.rest&&(d+=", ")}else d+=l,null!==a.rest&&(d+=", ");if(null===a||null===a.rest)break;a=a.rest}return d+")"};b=function(a,g,l,c,f,k){if(null===a)return c?"return null":"null";if(a instanceof $List){var h=car(a);if("def"===h||"="===h||"set!"===h||"const"===
h){l=car(cdr(a));var n=null,n=null===cdr(cdr(a))?null:null!=cdr(cdr(cdr(a)))?cons("fn",cons(car(cdr(cdr(a))),cdr(cdr(cdr(a))))):a.rest.rest.first;l=b(l);var n=b(n,null,null,null,!0,l),e=("def"===h?"var ":"const"===h?"const ":"")+l+" = "+n+" ";return c?e+"; return "+l:e}if("Array"===h){e=c?"return [":"[";for(a=cdr(a);null!=a;)e+=b(car(a),null,null,null,!0),null!=cdr(a)&&(e+=", "),a=cdr(a);return e+"]"}if("Object"===h){e=c?"return {":"{";for(a=a.rest;null!=a;){var m=b(a.first,null,null,null,!0);if(":"===
m[0])if(null!==a.rest&&":"!==a.rest.first[0])k=m.slice(1),k=A(k)===k&&isNaN(k)?k:'"'+k+'"',e+=k+": ";else{e+=m.slice(1)+(null==a.rest?"":", ");a=a.rest;continue}else e="'"===m[0]||'"'===m[0]?e+(m+": "):e+("["+m+"]: ");k=b(a.rest.first,null,null,null,!0);e+=k;null!=a.rest.rest&&(e+=", ");a=a.rest.rest}return e+="}"}if("quote"===h||"quasiquote"===h)return a.rest.first instanceof $List?(f=b("quote"===h?x(a.rest.first):w(a.rest.first)),c?"return "+f:f):null===a.rest?c?"return null":"null":isNaN(a.rest.first)?
c?'return "'+a.rest.first+'"':'"'+a.rest.first+'"':c?"return "+a.rest.first:a.rest.first;if("fn"===h||"fn*"===h){e="fn"===h?"function ":"function* ";c&&(e="return "+e);c="";"string"===typeof a.rest.first?(k=a.rest.first,c+=a.rest.first+"(",f=a.rest.rest.first,a=a.rest.rest.rest):(c+="(",f=a.rest.first,a=a.rest.rest);g=[];for(var q={},h=0,t=!1,u=null;null!=f;){var p=f.first;if("string"!==typeof p){if("Object"!==p.first)return console.log("ERROR: Invalid parameters"),"";h++;for(p=p.rest;null!==p;)l=
b(p.first),l='"'===l[0]?l.slice(1,-1):l,l=":"===l[0]?l.slice(1):l,n=b(p.rest.first,null,null,null,!0),q[l]=n,p=p.rest.rest;c+="__lisp_args__";f=f.rest;null!==f&&"&"!==f.first&&"."!==f.first&&(c+=", ");g.push(q)}else{p=b(p);if("&"===p){h++;u=b(f.rest.first);break}else if("."===p){h++;f=f.rest;u=p=b(f.first);t=!0;break}else if(":"===p[0]){h++;l=p.slice(1);c+=l;g.push([l,b(f.rest.first,null,null,null,!0)]);f=f.rest.rest;null!=f&&"&"!==f.first&&"."!==f.first&&(c+=", ");continue}else h++,c+=p,null!=f.rest&&
"&"!==f.rest.first&&"."!==f.rest.first&&(c+=", ");f=f.rest}}l=[k?k:!1];c+="){";u&&(c+="for(var "+u+" = [], $__0 = "+(h-1)+"; $__0 < arguments.length; $__0++)"+u+"[$__0 - "+(h-1)+"] = arguments[$__0];",t&&(c+=u+" = list.apply(null, "+u+");"));for(n=0;n<g.length;n++)if(f=g[n],f.constructor===Array)h=f[0],c+=h+" = ("+h+" === void 0 ? "+f[1]+" : "+h+" );";else for(m in c+="var __lisp_args_v__;",c+="__lisp_args__ = (__lisp_args__ === void 0 ? {} : __lisp_args__); ",f)c+="var "+m+" = ((__lisp_args_v__ = __lisp_args__."+
m+") === void 0 ? "+f[m]+" : __lisp_args_v__); ";c+=r(a,!0,null,l);!1!==l[0]&&l[0]!==k&&(e+=l[0]);return e+(c+"}")}if("let"===h){k={};f=cdr(a);for(e="((function(){";null!=f.rest;)l=f.first,m=f.rest.first,typeof("string"===l)?l in k?e+=l+" = "+b(m)+"; ":(k[l]=!0,e+="var "+l+" = "+b(m)+"; "):console.log("let implementation not finished yet"),f=f.rest.rest;e+=b(f.first,null,null,!0);e+="})())";return(c?"return ":"")+e}if("cond"===h){n=!1;g=a.rest;e="if(";f&&(e="(function(){"+e);m=b(g.first,null,null,
null,!0,null);e=e+m+"){";a=g.rest.first;e+=b(a,!0,l,c||f,null,k);e+="}";for(g=g.rest.rest;null!=g;)if(e+=" else ","else"!==g.first)e+="if (",m=b(g.first),e=e+m+"){",a=g.rest.first,e+=b(a,!0,l,c||f,null,k),e+="}",g=g.rest.rest;else{n=!0;e+="{";a=g.rest.first;e+=b(a,!0,l,c||f,null,k);e+="}";break}!1===n&&c&&(e+=" else return null");f&&(e+="})()");return e}if("if"===h)return e="(",m=a.rest.first,k=a.rest.rest.first,a=null===a.rest.rest.rest?null:a.rest.rest.rest.first,f?(e+=b(m)+" ? ",e+=b(k,g,l,null,
!0,null)+" : ",e+=b(a,g,l,null,!0,null)+")"):null===a?b(list("cond",m,k),g,l,c,f):b(list("cond",m,k,"else",a),g,l,c,f);if("do"===h)return f?"(function (){"+r(a.rest,!0)+"})()":r(a.rest,c,null,l);if("apply"===h)return k=b(a.rest.first),f=b(a.rest.rest.first,null,null,null,!0),(c?"return ":"")+"("+k+").apply(this, (function(){var temp = "+f+"; return temp instanceof $List ? temp.toArray() : temp})())";if("new"===h)return k=b(a.rest.first),e="(new "+k+""+B(a.rest.rest),e+=")",(c?"return ":"")+e;if("+"===
h||"-"===h||"*"===h||"/"===h||"%"===h||"=="===h||"<"===h||">"===h||"!="===h||"<="===h||">="===h||"&&"===h||"||"===h||"&"===h||"|"===h||"and"===h||"or"===h){e="(";f=a.rest;if(null==f.rest)return"+"===h||"*"===h||"%"===h?(c?"return ":"")+b(f.first,null,null,null,!0):"-"===h?(c?"return ":"")+"(-"+b(f.first,null,null,null,!0)+")":"/"===h?(c?"return ":"")+"(1/"+b(f.first,null,null,null,!0)+")":(c?"return ":"")+"true";for(;null!=f;)p=b(f.first,null,null,null,!0),e+=p,null!=f.rest&&("and"===h?h="&&":"or"===
h?h="||":"=="==h&&(h="==="),e+=" "+h+" "),f=f.rest;return(c?"return ":"")+e+")"}if("not"===h)return(c?"return ":"")+"(!"+b(a.rest.first,null,null,null,!0)+")";if("instanceof"===h)return(c?"return ":"")+"("+b(a.rest.first)+" instanceof "+b(a.rest.rest.first)+")";if("get"===h){e=f=b(a.rest.first);for(k=a.rest.rest;null!=k;)m=b(k.first),'"'===m[0]?(l=m.slice(1,-1),e=l===A(l)&&isNaN(l)?e+("."+l):e+("["+m+"]")):e+="["+m+"]",k=k.rest;return(c?"return ":"")+e}if("try"===h)return g=a.rest,a=g.first,e="try{"+
b(a,!0,l,c||f,null,k),e+="}",g=g.rest,null!=g&&"catch"===g.first&&(e+="catch(",m=b(g.rest.first),e+=m+"){",a=g.rest.rest.first,e+=b(a,!0,l,c||f,null,k),e+="}",g=g.rest.rest.rest),null!=g&&"finally"===g.first&&(a=g.rest.first,e+="finally {",e+=b(a,!0,l,c||f,null,k),e+="}"),e;if("throw"===h||"yield"===h)return h+" "+b(a.rest.first,null,null,null,!0)+(c?"; return;":"");if("in"===h)return(c?"return ":"")+"("+b(a.rest.first)+" in "+b(a.rest.rest.first)+")";if("defmacro"===h){e=b(a.rest.first);if("string"!=
typeof e)return console.log("ERROR: Invalid macro name: "+e.toString()),"";g=a.rest.rest;d[e]=g;return""}k=a.first;f=a.rest;k=b(k);"recur"===k&&g&&(!1===l[0]&&(l[0]="__lisp__recur__$"+s,s+=3),k=l[0],a.first=k);e=k;"}"!==k[k.length-1]&&isNaN(k)||(e="("+e+")");if(k in d)return e=C(d[k],f),(c?"return ":"")+b(e);e+=B(f);return(c?"return ":"")+e}return isNaN(a)&&"'"!==a[0]&&'"'!==a[0]&&":"!==a[0]?(c?"return ":"")+A(a):(c?"return ":"")+a};r=function(a,d,l,c){for(var f="",k,h=!1;null!=a;){d&&null==a.rest&&
(h=!0);k=b(a.first,null===a.rest?!0:!1,c,h);"string"===typeof k&&(k=k.trim());"string"===typeof k&&0!==k.length&&";"!==k[k.length-1]&&(k+="; ");if(l)if(node_environment)try{n=vm.runInContext(k,y,"lisp.vm")}catch(m){console.log(m)}else try{window.eval(k)}catch(e){console.log(e)}f+=k;a=a.rest}return f};return{lexer:m,parser:q,compiler:b,lisp_compiler:r,compile:function(a){a=m(a);if(null===a)return null;a=q(a);return r(a,!1,!0)},getEvalResult:function(){return n}}},lisp=lisp_module();
"undefined"!==typeof module&&(module.exports.compile=lisp.compile,module.exports.getEvalResult=lisp.getEvalResult);
