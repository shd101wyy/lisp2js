var $List,car,cdr,cons,list,list_module,__slice=[].slice; list_module=function(){var h,k,m;h=function(g,a){this.first=g;this.rest=a;return null};h.prototype.length=function(){var g;g=function(a,d){return null===a?d:g(a.rest,d+1)};return g(this,0)};h.prototype.toString=function(){var g;g=function(a,d){return null===a?d+")":a instanceof h?g(a.rest,d+(null===a.first?"()":a.first.toString())+(null===a.rest?"":", ")):d.slice(0,-2)+" . "+a.toString()+")"};return g(this,"(")};h.prototype.reverse=function(){var g;g=function(a,d){return a instanceof h?g(a.rest,k(a.first, d)):null===a?d:k(a,d)};return g(this,null)};h.prototype.slice=function(g,a){var d,f,b;null==a&&(a=null);if(null===a)return 0>g&&(g=this.length()+g),f=function(a,b){return 0===b?a:f(a.rest,b-1)},f(this,g);if(0>g||0>a)d=this.length(),g=0>g?d+g:g,a=0>a?d+a:a;b=function(a,d,f){return 0===d?0===f||null===a?null:k(a.first,b(a.rest,d,f-1)):b(a.rest,d-1,f)};return b(this,g,a-g)};h.prototype.ref=function(g){var a;0>g&&(g=this.length()+g);a=function(d,f){return null===d?null:0===f?d.first:a(d.rest,f-1)};return a(this, g)};h.prototype.append=function(){var g,a;a=1<=arguments.length?__slice.call(arguments,0):[];a=m.apply(m,a);g=function(a,f){return null===a?f:k(a.first,g(a.rest,f))};return g(this,a)};h.prototype.toArray=function(){var g,a;g=[];a=function(d){if(null===d)return g;g.push(d.first);return a(d.rest)};return a(this)};h.prototype.forEach=function(g){var a;a=function(d){if(null===d)return null;g(d.first);return a(d.rest)};return a(this)};h.prototype.foreach=h.prototype.forEach;h.prototype.map=function(g){var a; a=function(d){return null===d?null:k(g(d.first),a(d.rest))};return a(this)};h.prototype.filter=function(g){var a;a=function(d){return null===d?null:g(d.first)?k(d.first,a(d.rest)):a(d.rest)};return a(this)};k=function(g,a){return new h(g,a)};m=function(){var g,a;g=1<=arguments.length?__slice.call(arguments,0):[];a=function(d,f){return f===d.length?null:k(d[f],a(d,f+1))};return a(g,0)};return{list:m,cons:k,List:h,car:function(g){return g.first},cdr:function(g){return g.rest}}}();$List=list_module.List; list=list_module.list;cons=list_module.cons;car=list_module.car;cdr=list_module.cdr; var lisp_module=function(){var h,k,m=function(a){if(null==a)return null;var d=a.first;return d instanceof $List?cons("cons",cons(m(d),cons(m(a.rest),null))):"string"===typeof d&&"."===d?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(d,null)),cons(m(cdr(a)),null)))},g=function(a){if(null==a)return null;v=a.first;return v instanceof $List?"string"===typeof v.first&&"unquote"===v.first?cons("cons",cons(v.rest.first,cons(g(cdr(a)),null))):"string"==typeof v.first&&"unquote-splice"=== v.first?cons("append",cons(v.rest.first,cons(g(a.rest),null))):cons("cons",cons(g(v),cons(g(a.rest),null))):"string"===typeof v&&"."===v?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(v,null)),cons(g(a.rest),null)))};h=function(a){if(null===a)return"null";if(a instanceof $List){var d=car(a);if("def"===d||"="===d||"set!"===d){var f=car(cdr(a)),b=null,b=null===cdr(cdr(a))?null:"def"===d&&null!=cdr(cdr(cdr(a)))?cons("fn",cons(car(cdr(cdr(a))),cdr(cdr(cdr(a))))):a.rest.rest.first; return("def"===d?"var ":"")+h(f)+" = "+h(b)+" "}if("["===d){b="[";for(a=cdr(a);null!=a;)b+=h(car(a)),null!=cdr(a)&&(b+=", "),a=cdr(a);return b+"]"}if("{"===d){b="{";for(a=a.rest;null!=a;){var e=h(a.first),f=h(a.rest.first),b=":"===e[0]?b+(e.slice(1)+": "):"'"===e[0]||'"'===e[0]?b+(e+": "):b+("["+e+"]: "),b=b+f;null!=a.rest.rest&&(b+=", ");a=a.rest.rest}return b+="}"}if("[["===d)return h(a.rest.first)+"["+h(a.rest.rest.first)+"]";if("quote"===d||"quasiquote"===d)return a.rest.first instanceof $List? h("quote"===d?m(a.rest.first):g(a.rest.first)):null===a.rest?"null":isNaN(a.rest.first)?'"'+a.rest.first+'"':a.rest.first;if("fn"===d){b="function (";for(e=a.rest.first;null!=e;)f=e.first,f=h(f),":"===f[0]?b+=f.slice(1)+"=":"."===f?(e=e.rest,b+="..."+e.first):(b+=f,null!=e.rest&&(b+=", ")),e=e.rest;b+="){";b+=k(a.rest.rest,!0);return b+="}"}if("let"===d){d={};e=cdr(a);for(b="{";null!=e.rest;)f=e.first,a=e.rest.first,typeof("string"===f)?f in d?b+=f+" = "+h(a)+"; ":(d[f]=!0,b+="let "+f+" = "+h(a)+ "; "):console.log("let implementation not finished yet"),e=e.rest.rest;b+=h(e.first);return b+"}"}if("if"===d)return e=a.rest.rest.first,f=null===a.rest.rest.rest?null:a.rest.rest.rest.first,b="("+(h(a.rest.first)+" ? "),b+=h(e)+" : ",b+=h(f)+")";if("do"===d)return"(function (){"+k(a.rest,!0)+"})()";if("apply"===d)return b=h(a.rest.first),e=h(a.rest.rest.first),b+".apply(this, "+e+")";if("+"===d||"-"===d||"*"===d||"/"===d||"=="===d||"<"===d||">"===d||"!="===d||"<="===d||">="===d||"&&"===d||"||"=== d||"&"===d||"|"===d){b="(";for(e=a.rest;null!=e;)f=h(e.first),b+=f,null!=e.rest&&(b+=" "+("=="===d?"===":d)+" "),e=e.rest;return b+")"}b=a.first;e=a.rest;b=h(b);null!=e?(f=h(e.first),b="."===f[0]?b+(f+"("):b+("("+f),e=e.rest,null!=e&&(b+=", ")):b+="(";for(;null!=e;)f=e.first,f=h(f),":"===f[0]?b+=f.slice(1)+"=":(b+=f,null!=e.rest&&(b+=", ")),e=e.rest;return b+=")"}if(isNaN(a)){b="";for(e=0;e<a.length;e++)f=a.charCodeAt(e),b=47<f&&58>f||64<f&&91>f||96<f&&123>f||"$"===a[e]||"_"===a[e]?b+a[e]:b+f;isNaN(b[0])|| (b="_"+b);return b}return a};k=function(a,d){for(var f="";null!=a;)d&&null==a.rest&&(f+="return "),f+=h(a.first),f+="; ",a=a.rest;return f};return{lexer:function(a){for(var d=[],f=0,b=0;b<a.length;b++)if("("===a[b])d.push("("),f++;else if("["===a[b]){if(0!=b&&" "!==a[b-1]&&"\n"!==a[b-1]&&"\t"!==a[b-1]&&"'"!==a[b-1]&&"`"!==a[b-1]&&"~"!==a[b-1]&&"("!==a[b-1]&&"{"!==a[b-1]&&"["!==a[b-1])if(j=d.length-1,p=")"===d[j]?1:0,0==p)d.push("[["),d.push(d[j]),d[j]="(";else{d.push("");d.push("");d[j+2]=d[j];for(--j;;){d[j+ 2]=d[j];")"===d[j]&&p++;"("===d[j]&&p--;if(0==p)break;j--}d[j]="(";d[j+1]="[["}else d.push("("),d.push("[");f++}else if("{"===a[b])d.push("("),d.push("{"),f++;else if(")"===a[b]||"]"===a[b]||"}"===a[b])d.push(")"),f--;else if(" "!==a[b]&&"\n"!==a[b]&&"\t"!=a[b]&&","!=a[b])if("~"===a[b]&&"@"===a[b+1])d.push("~@"),b++;else if("`"===a[b]||"~"===a[b]||"'"===a[b])d.push(a[b]);else if(";"===a[b])for(;b!=a.length&&"\n"!==a[b];)b++;else if('"'===a[b]){for(var e=b+1;e!=a.length;)if("\\"===a[e])e+=2;else{if('"'=== a[e])break;e++}d.push(a.slice(b,e+1));b=e}else{for(e=b+1;e!==a.length&&" "!==a[e]&&"\n"!==a[e]&&"\t"!==a[e]&&","!==a[e]&&")"!==a[e]&&"("!==a[e]&&"]"!==a[e]&&"["!==a[e]&&"{"!==a[e]&&"}"!==a[e]&&"'"!==a[e]&&"`"!==a[e]&&"~"!==a[e]&&";"!==a[e]&&":"!==a[e];)e+=1;b=a.slice(b,e);d.push(b);b=e-1}return 0!=f?null:d},parser:function(a){var d={"'":"quote","~":"unquote","~@":"unquote-splice","`":"quasiquote"};if(null===a)return null;var f=null,b,e=null,g=null;for(b=a.length-1;0<=b;b--)")"===a[b]?(e=cons(f,e), f=null):"("===a[b]?(0==b||"~@"!==a[b-1]&&"'"!==a[b-1]&&"~"!==a[b-1]&&"`"!==a[b-1]?f=cons(f,car(e)):(f=cons(cons(d[a[b-1]],cons(f,null)),car(e)),b--),e=cdr(e)):(g=a[b],0==b||"~@"!==a[b-1]&&"'"!==a[b-1]&&"~"!==a[b-1]&&"`"!==a[b-1]?f=cons(g,f):(f=cons(cons(d[a[b-1]],cons(g,null)),f),b--));return f},compiler:h,lisp_compiler:k}},lisp=lisp_module(),lexer=lisp.lexer,parser=lisp.parser,compiler=lisp.compiler,lisp_compiler=lisp.lisp_compiler,l=lexer("`(~x y (+ 3 4))");console.log(l);var p=parser(l);console.log(p.toString()); var c=lisp_compiler(p,!1);console.log(c);
