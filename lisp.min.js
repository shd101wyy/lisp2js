var node_environment=!1,vm=null;"undefined"!=typeof module&&(vm=require("vm"),node_environment=!0);var $List,car,cdr,cons,list,list_module,__slice=[].slice;
list_module=function(){var p,r,b;p=function(b,g){this.first=b;this.rest=g;return null};p.prototype.length=function(){var b;b=function(g,k){return null===g?k:b(g.rest,k+1)};return b(this,0)};p.prototype.toString=function(){var b;b=function(g,k){return null===g?k+")":g instanceof p?b(g.rest,k+(null===g.first?"()":g.first.toString())+(null===g.rest?"":", ")):k.slice(0,-2)+" . "+g.toString()+")"};return b(this,"(")};p.prototype.reverse=function(){var b;b=function(g,k){return g instanceof p?b(g.rest,r(g.first,
k)):null===g?k:r(g,k)};return b(this,null)};p.prototype.slice=function(b,g){var k,p,t;null==g&&(g=null);if(null===g)return 0>b&&(b=this.length()+b),p=function(b,g){return 0===g?b:p(b.rest,g-1)},p(this,b);if(0>b||0>g)k=this.length(),b=0>b?k+b:b,g=0>g?k+g:g;t=function(b,g,k){return 0===g?0===k||null===b?null:r(b.first,t(b.rest,g,k-1)):t(b.rest,g-1,k)};return t(this,b,g-b)};p.prototype.ref=function(b){var g;0>b&&(b=this.length()+b);g=function(b,s){return null===b?null:0===s?b.first:g(b.rest,s-1)};return g(this,
b)};p.prototype.append=function(){var s,g;g=1<=arguments.length?__slice.call(arguments,0):[];g=b.apply(b,g);s=function(b,g){return null===b?g:r(b.first,s(b.rest,g))};return s(this,g)};p.prototype.toArray=function(){var b,g;b=[];g=function(k){if(null===k)return b;b.push(k.first);return g(k.rest)};return g(this)};p.prototype.forEach=function(b){var g;g=function(k){if(null===k)return null;b(k.first);return g(k.rest)};return g(this)};p.prototype.foreach=p.prototype.forEach;p.prototype.map=function(b){var g;
g=function(k){return null===k?null:r(b(k.first),g(k.rest))};return g(this)};p.prototype.filter=function(b){var g;g=function(k){return null===k?null:b(k.first)?r(k.first,g(k.rest)):g(k.rest)};return g(this)};r=function(b,g){return new p(b,g)};b=function(){var b,g;b=1<=arguments.length?__slice.call(arguments,0):[];g=function(b,p){return p===b.length?null:r(b[p],g(b,p+1))};return g(b,0)};return{list:b,cons:r,List:p,car:function(b){return b.first},cdr:function(b){return b.rest}}}();$List=list_module.List;
list=list_module.list;cons=list_module.cons;car=list_module.car;cdr=list_module.cdr;"undefined"!==typeof module&&(module.exports.$List=$List,module.exports.list=list,module.exports.cons=cons,module.exports.car=car,module.exports.cdr=cdr);
var lisp_module=function(){var p,r,b,s,g={},k="",z=null,t=0,A=function(a,d){return null===a?d instanceof $List||null===d?d:cons(d,null):cons(a.first,A(a.rest,d))};node_environment?z=vm.createContext({cons:cons,car:car,cdr:cdr,list:list,$List:$List,append:A,console:console}):window.append=A;p=function(a){for(var d=[],b=0,c=0;c<a.length;c++)if("("===a[c])d.push("("),b++;else if("["===a[c]){if(0!=c&&" "!==a[c-1]&&"\n"!==a[c-1]&&"\t"!==a[c-1]&&"'"!==a[c-1]&&"`"!==a[c-1]&&"~"!==a[c-1]&&"("!==a[c-1]&&"{"!==
a[c-1]&&"["!==a[c-1])if(n=d.length-1,h=")"===d[n]?1:0,0==h)d.push("get"),d.push(d[n]),d[n]="(";else{d.push("");d.push("");d[n+2]=d[n];for(--n;;){d[n+2]=d[n];")"===d[n]&&h++;"("===d[n]&&h--;if(0==h)break;n--}d[n]="(";d[n+1]="get"}else d.push("("),d.push("Array");b++}else if("{"===a[c])d.push("("),d.push("Object"),b++;else if(")"===a[c]||"]"===a[c]||"}"===a[c])d.push(")"),b--;else if(" "!==a[c]&&"\n"!==a[c]&&"\t"!=a[c]&&","!=a[c])if("~"===a[c]&&"@"===a[c+1])d.push("~@"),c++;else if("`"===a[c]||"~"===
a[c]||"'"===a[c])d.push(a[c]);else if(";"===a[c])for(;c!=a.length&&"\n"!==a[c];)c++;else if('"'===a[c]){for(var f=c+1;f!=a.length;)if("\\"===a[f])f+=2;else{if('"'===a[f])break;f++}d.push(a.slice(c,f+1));c=f}else{for(f=c+1;f!==a.length&&" "!==a[f]&&"\n"!==a[f]&&"\t"!==a[f]&&","!==a[f]&&")"!==a[f]&&"("!==a[f]&&"]"!==a[f]&&"["!==a[f]&&"{"!==a[f]&&"}"!==a[f]&&"'"!==a[f]&&"`"!==a[f]&&"~"!==a[f]&&";"!==a[f]&&":"!==a[f]&&"."!==a[f];)f+=1;var g=a.slice(c,f);if("."===g[0]&&")"===d[d.length-1]&&" "!==a[c-1]&&
"\n"!==a[c-1]&&"\t"!==a[c-1]){var h=1,n=d.length-1;d.push("");d.push("");d[n+2]=d[n];for(--n;;){d[n+2]=d[n];")"===d[n]&&h++;"("===d[n]&&h--;if(0==h)break;n--}d[n]="(";d[n+1]="get";d.push('"'+g.slice(1)+'"');d.push(")")}else"."===g[0]&&0<c&&" "!==a[c-1]&&"\t"!==a[c-1]&&"\n"!==a[c-1]&&"{"!==a[c-1]&&"("!==a[c-1]&&"}"!==a[c-1]&&")"!==a[c-1]?(c=d[d.length-1],d[d.length-1]="(",d.push("get"),d.push(c),d.push('"'+g.slice(1)+'"'),d.push(")")):"."===g[0]&&'"'===a[c-1]?d[d.length-1]+=g:d.push(g);c=f-1}return 0!=
b?null:d};r=function(a){var d={"'":"quote","~":"unquote","~@":"unquote-splice","`":"quasiquote"};if(null===a)return null;var b=null,c,f=null,g=null;for(c=a.length-1;0<=c;c--)")"===a[c]?(f=cons(b,f),b=null):"("===a[c]?(0==c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?b=cons(b,car(f)):(b=cons(cons(d[a[c-1]],cons(b,null)),car(f)),c--),f=cdr(f)):(g=a[c],0==c||"~@"!==a[c-1]&&"'"!==a[c-1]&&"~"!==a[c-1]&&"`"!==a[c-1]?b=cons(g,b):(b=cons(cons(d[a[c-1]],cons(g,null)),b),c--));return b};var y=
function(a){if(null==a)return null;var d=a.first;return d instanceof $List?cons("cons",cons(y(d),cons(y(a.rest),null))):"string"===typeof d&&"."===d?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(d,null)),cons(y(cdr(a)),null)))},B=function(a){for(var d="",b=0;b<a.length;b++)var c=a.charCodeAt(b),d=47<c&&58>c||64<c&&91>c||96<c&&123>c||"$"===a[b]||"_"===a[b]||"."===a[b]||"&"===a[b]||255<c?d+a[b]:d+("_$"+c+"_");isNaN(d[0])||(d="_"+d);return d},w=function(a){if(null==a)return null;
v=a.first;return v instanceof $List?"string"===typeof v.first&&"unquote"===v.first?cons("cons",cons(v.rest.first,cons(w(cdr(a)),null))):"string"==typeof v.first&&"unquote-splice"===v.first?cons("append",cons(v.rest.first,cons(w(a.rest),null))):cons("cons",cons(w(v),cons(w(a.rest),null))):"string"===typeof v&&"."===v?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(v,null)),cons(w(a.rest),null)))},x=function(a,d,b){if(null===a&&null===d)return b;if(null===a&&null!==d||null!==
a&&null===d&&"."!==a.first)return 0;if(a.first instanceof $List&&d.first instanceof $List)return x(a.first,d.first,b)?x(a.rest,d.rest,b):0;if(a.first instanceof $List&&!(d.first instanceof $List))return 0;if("string"===typeof a.first&&"#"===a.first[0])return"string"!==typeof d.first?0:a.first.slice(1)===d.first?x(a.rest,d.rest,b):0;if("string"===typeof a.first&&"."===a.first)return b[a.rest.first]=d,b;b[a.first]=d.first;return x(a.rest,d.rest,b)},E=function(a,d){for(var g=function(a){if(null===a)return null;
if(a.first instanceof $List)return cons(cons("list",g(a.first)),g(a.rest));if('"'===a.first[0]){for(var c="",b=0;b<a.first.length;b++)c='"'===a.first[b]?c+'\\"':"\\"===a.first[b]?c+"\\\\":"\n"===a.first[b]?c+"\\n":"\t"===a.first[b]?c+"\\t":c+a.first[b];return cons('"'+c+'"',g(a.rest))}return null===a.first?cons(a.first,g(a.rest)):cons('"'+a.first+'"',g(a.rest))};null!=a;){var c=x(a.first,d,{});if(c){var f="(function(){";for(key in c)f=c[key]instanceof $List?f+("var "+key+" = "+b(cons("list",g(c[key])))+
"; "):null===c[key]?f+("var "+key+" = null; "):f+("var "+key+" = "+b('"'+c[key])+'"; ');f+="return ("+b(a.rest.first)+");";f+="})();";if(node_environment)try{return vm.runInContext(f,z,"lisp.vm")}catch(l){return console.log(l),""}else try{return window.eval(f)}catch(h){return console.log(h),""}}a=a.rest.rest}console.log("ERROR: Failed to expand macro\n");return""},C=function(a){for(var d="",g=!1;null!=a;){var c=a.first,c=b(c,null,null,null,!0);if("string"===typeof c&&":"===c[0])for(!1===g?(d+="(",
g=!0):d+=", ",d+="{"+c.slice(1)+": "+b(a.rest.first,null,null,null,!0),a=a.rest.rest;;){if(null===a){d+="}";break}c=b(a.first,null,null,null,!0);if(":"!==c[0]){d+="}, "+c;break}if(null===a.rest)return console.log("ERROR: Invalid parameter name"),"";var f=b(a.rest.first,null,null,null,!0),d=d+(", "+c.slice(1)+": "+f);a=a.rest.rest}else!1===g?(d+="(",g=!0):d+=", ",d+=c;if(null===a||null===a.rest)break;a=a.rest}g&&(d+=")");return 0===d.trim().length?"()":d},D=function(a){if('"'===a[0]||"."==a[0]){var b=
"."===a[0]?a.slice(1):a.slice(1,-1);return b===B(b)&&isNaN(b)?"."+b:"["+a+"]"}return"["+a+"]"};b=function(a,d,m,c,f,l){if(null===a)return c?"return null":"null";if(a instanceof $List){var h=car(a);if("def"===h||"="===h||"set!"===h||"const"===h){m=car(cdr(a));var n=null,n=null===cdr(cdr(a))?null:null!=cdr(cdr(cdr(a)))?cons("fn",cons(car(cdr(cdr(a))),cdr(cdr(cdr(a))))):a.rest.rest.first;m=b(m);var n=b(n,null,null,null,!0,m),e=("def"===h?"var ":"const"===h?"const ":"")+m+" = "+n+" ";return c?e+"; return "+
m:e}if("Array"===h){e=c?"return [":"[";for(a=cdr(a);null!=a;)e+=b(car(a),null,null,null,!0),null!=cdr(a)&&(e+=", "),a=cdr(a);return e+"]"}if("Object"===h){e=c?"return {":"{";for(a=a.rest;null!=a;){var k=b(a.first,null,null,null,!0);if(":"===k[0])if(null!==a.rest&&":"!==a.rest.first[0])l=k.slice(1),l=B(l)===l&&isNaN(l)?l:'"'+l+'"',e+=l+": ";else{e+=k.slice(1)+(null==a.rest?"":", ");a=a.rest;continue}else e="'"===k[0]||'"'===k[0]?e+(k+": "):e+("["+k+"]: ");l=b(a.rest.first,null,null,null,!0);e+=l;null!=
a.rest.rest&&(e+=", ");a=a.rest.rest}return e+="}"}if("quote"===h||"quasiquote"===h)return a.rest.first instanceof $List?(f=b("quote"===h?y(a.rest.first):w(a.rest.first)),c?"return "+f:f):null===a.rest?c?"return null":"null":isNaN(a.rest.first)?c?'return "'+a.rest.first+'"':'"'+a.rest.first+'"':c?"return "+a.rest.first:a.rest.first;if("fn"===h||"fn*"===h){e="fn"===h?"function ":"function* ";c&&(e="return "+e);c="";"string"===typeof a.rest.first?(l=a.rest.first,c+=a.rest.first+"(",f=a.rest.rest.first,
a=a.rest.rest.rest):(c+="(",f=a.rest.first,a=a.rest.rest);d=[];for(var p={},h=0,r=!1,u=null;null!=f;){var q=f.first;if("string"!==typeof q){if("Object"!==q.first)return console.log("ERROR: Invalid parameters"),"";h++;for(q=q.rest;null!==q;)m=b(q.first),m='"'===m[0]?m.slice(1,-1):m,m=":"===m[0]?m.slice(1):m,n=b(q.rest.first,null,null,null,!0),p[m]=n,q=q.rest.rest;c+="__lisp_args__";f=f.rest;null!==f&&"&"!==f.first&&"."!==f.first&&(c+=", ");d.push(p)}else{q=b(q);if("&"===q){h++;u=b(f.rest.first);break}else if("."===
q){h++;f=f.rest;u=q=b(f.first);r=!0;break}else if(":"===q[0]){h++;m=q.slice(1);c+=m;d.push([m,b(f.rest.first,null,null,null,!0)]);f=f.rest.rest;null!=f&&"&"!==f.first&&"."!==f.first&&(c+=", ");continue}else h++,c+=q,null!=f.rest&&"&"!==f.rest.first&&"."!==f.rest.first&&(c+=", ");f=f.rest}}m=[l?l:!1];c+="){";u&&(c+="for(var "+u+" = [], $__0 = "+(h-1)+"; $__0 < arguments.length; $__0++)"+u+"[$__0 - "+(h-1)+"] = arguments[$__0];",r&&(c+=u+" = list.apply(null, "+u+");"));for(n=0;n<d.length;n++)if(f=d[n],
f.constructor===Array)h=f[0],c+=h+" = ("+h+" === void 0 ? "+f[1]+" : "+h+" );";else for(k in c+="var __lisp_args_v__;",c+="__lisp_args__ = (__lisp_args__ === void 0 ? {} : __lisp_args__); ",f)c+="var "+k+" = ((__lisp_args_v__ = __lisp_args__."+k+") === void 0 ? "+f[k]+" : __lisp_args_v__); ";c+=s(a,!0,null,m);!1!==m[0]&&m[0]!==l&&(e+=m[0]);return e+(c+"}")}if("let"===h){l={};f=cdr(a);for(e="((function(){";null!=f.rest;)m=f.first,k=f.rest.first,typeof("string"===m)?m in l?e+=m+" = "+b(k)+"; ":(l[m]=
!0,e+="var "+m+" = "+b(k)+"; "):console.log("let implementation not finished yet"),f=f.rest.rest;e+=b(f.first,null,null,!0);e+="})())";return(c?"return ":"")+e}if("cond"===h){n=!1;d=a.rest;e="if(";f&&(e="(function(){"+e);k=b(d.first,null,null,null,!0,null);e=e+k+"){";a=d.rest.first;e+=b(a,!0,m,c||f,null,l);e+="}";for(d=d.rest.rest;null!=d;)if(e+=" else ","else"!==d.first)e+="if (",k=b(d.first),e=e+k+"){",a=d.rest.first,e+=b(a,!0,m,c||f,null,l),e+="}",d=d.rest.rest;else{n=!0;e+="{";a=d.rest.first;
e+=b(a,!0,m,c||f,null,l);e+="}";break}!1===n&&c&&(e+=" else return null");f&&(e+="})()");return e}if("if"===h)return e="(",k=a.rest.first,l=a.rest.rest.first,a=null===a.rest.rest.rest?null:a.rest.rest.rest.first,f?(e+=b(k)+" ? ",e+=b(l,d,m,null,!0,null)+" : ",e+=b(a,d,m,null,!0,null)+")"):null===a?b(list("cond",k,l),d,m,c,f):b(list("cond",k,l,"else",a),d,m,c,f);if("do"===h)return f?"(function (){"+s(a.rest,!0)+"})()":s(a.rest,c,null,m);if("apply"===h)return l=b(a.rest.first),f=b(a.rest.rest.first,
null,null,null,!0),(c?"return ":"")+"("+l+").apply(this, (function(){var temp = "+f+"; return temp instanceof $List ? temp.toArray() : temp})())";if("new"===h)return l=b(a.rest.first),e="(new "+l+""+C(a.rest.rest),e+=")",(c?"return ":"")+e;if("+"===h||"-"===h||"*"===h||"/"===h||"%"===h||"=="===h||"<"===h||">"===h||"!="===h||"<="===h||">="===h||"&&"===h||"||"===h||"&"===h||"|"===h||"and"===h||"or"===h){e="(";f=a.rest;if(null==f.rest)return"+"===h||"*"===h||"%"===h?(c?"return ":"")+b(f.first,null,null,
null,!0):"-"===h?(c?"return ":"")+"(-"+b(f.first,null,null,null,!0)+")":"/"===h?(c?"return ":"")+"(1/"+b(f.first,null,null,null,!0)+")":(c?"return ":"")+"true";for(;null!=f;)q=b(f.first,null,null,null,!0),e+=q,null!=f.rest&&("and"===h?h="&&":"or"===h?h="||":"=="==h&&(h="==="),e+=" "+h+" "),f=f.rest;return(c?"return ":"")+e+")"}if("not"===h)return(c?"return ":"")+"(!"+b(a.rest.first,null,null,null,!0)+")";if("instanceof"===h)return(c?"return ":"")+"("+b(a.rest.first)+" instanceof "+b(a.rest.rest.first)+
")";if("get"===h){e=f=b(a.rest.first,null,null,null,!0);for(l=a.rest.rest;null!==l;)k=b(l.first,null,null,null,!0),e+=D(k),l=l.rest;return(c?"return ":"")+e}if("->"===h){e=f=b(a.rest.first,null,null,null,!0);for(l=a.rest.rest;null!==l;)m=!1,l.first instanceof $List?(m=!0,k=b(l.first.first,null,null,null,!0)):k=b(l.first,null,null,null,!0),e+=D(k),m&&(f=l.first.rest,e+=C(f)),l=l.rest;return(c?"return ":"")+e}if("try"===h)return d=a.rest,a=d.first,e="try{"+b(a,!0,m,c||f,null,l),e+="}",d=d.rest,null!=
d&&"catch"===d.first&&(e+="catch(",k=b(d.rest.first),e+=k+"){",a=d.rest.rest.first,e+=b(a,!0,m,c||f,null,l),e+="}",d=d.rest.rest.rest),null!=d&&"finally"===d.first&&(a=d.rest.first,e+="finally {",e+=b(a,!0,m,c||f,null,l),e+="}"),e;if("throw"===h||"yield"===h)return h+" "+b(a.rest.first,null,null,null,!0)+(c?"; return;":"");if("in"===h)return(c?"return ":"")+"("+b(a.rest.first)+" in "+b(a.rest.rest.first)+")";if("defmacro"===h){e=b(a.rest.first);if("string"!=typeof e)return console.log("ERROR: Invalid macro name: "+
e.toString()),"";d=a.rest.rest;g[e]=d;return""}l=a.first;f=a.rest;l=b(l);"recur"===l&&d&&(!1===m[0]&&(m[0]="__lisp__recur__$"+t,t+=3),l=m[0],a.first=l);e=l;"}"!==l[l.length-1]&&isNaN(l)||(e="("+e+")");if(l in g)return e=E(g[l],f),(c?"return ":"")+b(e);e+=C(f);return(c?"return ":"")+e}return isNaN(a)&&"'"!==a[0]&&'"'!==a[0]&&":"!==a[0]?(c?"return ":"")+B(a):(c?"return ":"")+a};s=function(a,d,g,c,f){for(var l="",h,n=!1;null!=a;){d&&null==a.rest&&(n=!0);h=b(a.first,null===a.rest?!0:!1,c,n);"string"===
typeof h&&(h=h.trim());"string"===typeof h&&0!==h.length&&";"!==h[h.length-1]&&(h+="; ");if(g)if(node_environment)try{k=vm.runInContext(h,z,"lisp.vm"),f&&console.log(k)}catch(e){console.log(e)}else try{k=window.eval(h),f&&console.log(k)}catch(p){console.log(p)}l+=h;a=a.rest}return l};return{lexer:p,parser:r,compiler:b,lisp_compiler:s,compile:function(a,b){var g=p(a);if(null===g)return null;g=r(g);return s(g,!1,!0,null,b)},getEvalResult:function(){return k}}},lisp=lisp_module();
"undefined"!==typeof module&&(module.exports.compile=lisp.compile,module.exports.getEvalResult=lisp.getEvalResult);
