var node_environment=!1,vm=null;"undefined"!=typeof module&&(vm=require("vm"),node_environment=!0);var $List,car,cdr,cons,list,list_module,__slice=[].slice;
list_module=function(){var l,q,d;l=function(d,g){this.first=d;this.rest=g;return null};l.prototype.length=function(){var d;d=function(g,m){return null===g?m:d(g.rest,m+1)};return d(this,0)};l.prototype.toString=function(){var d;d=function(g,m){return null===g?m+")":g instanceof l?d(g.rest,m+(null===g.first?"()":g.first.toString())+(null===g.rest?"":", ")):m.slice(0,-2)+" . "+g.toString()+")"};return d(this,"(")};l.prototype.reverse=function(){var d;d=function(g,m){return g instanceof l?d(g.rest,q(g.first,
m)):null===g?m:q(g,m)};return d(this,null)};l.prototype.slice=function(d,g){var m,l,s;null==g&&(g=null);if(null===g)return 0>d&&(d=this.length()+d),l=function(d,g){return 0===g?d:l(d.rest,g-1)},l(this,d);if(0>d||0>g)m=this.length(),d=0>d?m+d:d,g=0>g?m+g:g;s=function(d,g,m){return 0===g?0===m||null===d?null:q(d.first,s(d.rest,g,m-1)):s(d.rest,g-1,m)};return s(this,d,g-d)};l.prototype.ref=function(d){var g;0>d&&(d=this.length()+d);g=function(d,r){return null===d?null:0===r?d.first:g(d.rest,r-1)};return g(this,
d)};l.prototype.append=function(){var r,g;g=1<=arguments.length?__slice.call(arguments,0):[];g=d.apply(d,g);r=function(d,g){return null===d?g:q(d.first,r(d.rest,g))};return r(this,g)};l.prototype.toArray=function(){var d,g;d=[];g=function(m){if(null===m)return d;d.push(m.first);return g(m.rest)};return g(this)};l.prototype.forEach=function(d){var g;g=function(m){if(null===m)return null;d(m.first);return g(m.rest)};return g(this)};l.prototype.foreach=l.prototype.forEach;l.prototype.map=function(d){var g;
g=function(m){return null===m?null:q(d(m.first),g(m.rest))};return g(this)};l.prototype.filter=function(d){var g;g=function(m){return null===m?null:d(m.first)?q(m.first,g(m.rest)):g(m.rest)};return g(this)};q=function(d,g){return new l(d,g)};d=function(){var d,g;d=1<=arguments.length?__slice.call(arguments,0):[];g=function(d,l){return l===d.length?null:q(d[l],g(d,l+1))};return g(d,0)};return{list:d,cons:q,List:l,car:function(d){return d.first},cdr:function(d){return d.rest}}}();$List=list_module.List;
list=list_module.list;cons=list_module.cons;car=list_module.car;cdr=list_module.cdr;"undefined"!==typeof module&&(module.exports.$List=$List,module.exports.list=list,module.exports.cons=cons,module.exports.car=car,module.exports.cdr=cdr);
var lisp_module=function(){var l,q,d,r,g={},m="",z=null,s=0,A=function(a,c){return null===a?c instanceof $List||null===c?c:cons(c,null):cons(a.first,A(a.rest,c))};node_environment?z=vm.createContext({cons:cons,car:car,cdr:cdr,list:list,$List:$List,append:A,console:console}):window.append=A;l=function(a){for(var c=[],d=0,b=0;b<a.length;b++)if("("===a[b])c.push("("),d++;else if("["===a[b]){if(0!=b&&" "!==a[b-1]&&"\n"!==a[b-1]&&"\t"!==a[b-1]&&"'"!==a[b-1]&&"`"!==a[b-1]&&"~"!==a[b-1]&&"("!==a[b-1]&&"{"!==
a[b-1]&&"["!==a[b-1])if(g=c.length-1,h=")"===c[g]?1:0,0==h)c.push("get"),c.push(c[g]),c[g]="(";else{c.push("");c.push("");c[g+2]=c[g];for(--g;;){c[g+2]=c[g];")"===c[g]&&h++;"("===c[g]&&h--;if(0==h)break;g--}c[g]="(";c[g+1]="get"}else c.push("("),c.push("Array");d++}else if("{"===a[b])c.push("("),c.push("Object"),d++;else if(")"===a[b]||"]"===a[b]||"}"===a[b])c.push(")"),d--;else if(" "!==a[b]&&"\n"!==a[b]&&"\t"!=a[b]&&","!=a[b])if("~"===a[b]&&"@"===a[b+1])c.push("~@"),b++;else if("`"===a[b]||"~"===
a[b]||"'"===a[b])c.push(a[b]);else if(";"===a[b])for(;b!=a.length&&"\n"!==a[b];)b++;else if('"'===a[b]){for(var f=b+1;f!=a.length;)if("\\"===a[f])f+=2;else{if('"'===a[f])break;f++}c.push(a.slice(b,f+1));b=f}else{for(f=b+1;f!==a.length&&" "!==a[f]&&"\n"!==a[f]&&"\t"!==a[f]&&","!==a[f]&&")"!==a[f]&&"("!==a[f]&&"]"!==a[f]&&"["!==a[f]&&"{"!==a[f]&&"}"!==a[f]&&"'"!==a[f]&&"`"!==a[f]&&"~"!==a[f]&&";"!==a[f]&&":"!==a[f]&&"."!==a[f];)f+=1;var k=a.slice(b,f);if("."===k[0]&&")"===c[c.length-1]&&" "!==a[b-1]&&
"\n"!==a[b-1]&&"\t"!==a[b-1]){var h=1,g=c.length-1;c.push("");c.push("");c[g+2]=c[g];for(--g;;){c[g+2]=c[g];")"===c[g]&&h++;"("===c[g]&&h--;if(0==h)break;g--}c[g]="(";c[g+1]="get";c.push('"'+k.slice(1)+'"');c.push(")")}else"."===k[0]&&0<b&&" "!==a[b-1]&&"\t"!==a[b-1]&&"\n"!==a[b-1]&&"{"!==a[b-1]&&"("!==a[b-1]&&"}"!==a[b-1]&&")"!==a[b-1]?(b=c[c.length-1],c[c.length-1]="(",c.push("get"),c.push(b),c.push('"'+k.slice(1)+'"'),c.push(")")):"."===k[0]&&'"'===a[b-1]?c[c.length-1]+=k:c.push(k);b=f-1}return 0!=
d?null:c};q=function(a){var c={"'":"quote","~":"unquote","~@":"unquote-splice","`":"quasiquote"};if(null===a)return null;var d=null,b,f=null,g=null;for(b=a.length-1;0<=b;b--)")"===a[b]?(f=cons(d,f),d=null):"("===a[b]?(0==b||"~@"!==a[b-1]&&"'"!==a[b-1]&&"~"!==a[b-1]&&"`"!==a[b-1]?d=cons(d,car(f)):(d=cons(cons(c[a[b-1]],cons(d,null)),car(f)),b--),f=cdr(f)):(g=a[b],0==b||"~@"!==a[b-1]&&"'"!==a[b-1]&&"~"!==a[b-1]&&"`"!==a[b-1]?d=cons(g,d):(d=cons(cons(c[a[b-1]],cons(g,null)),d),b--));return d};var x=
function(a){if(null==a)return null;var c=a.first;return c instanceof $List?cons("cons",cons(x(c),cons(x(a.rest),null))):"string"===typeof c&&"."===c?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(c,null)),cons(x(cdr(a)),null)))},B=function(a){for(var c="",d=0;d<a.length;d++)var b=a.charCodeAt(d),c=47<b&&58>b||64<b&&91>b||96<b&&123>b||"$"===a[d]||"_"===a[d]||"."===a[d]||"&"===a[d]||255<b?c+a[d]:c+("_$"+b+"_");isNaN(c[0])||(c="_"+c);return c},w=function(a){if(null==a)return null;
v=a.first;return v instanceof $List?"string"===typeof v.first&&"unquote"===v.first?cons("cons",cons(v.rest.first,cons(w(cdr(a)),null))):"string"==typeof v.first&&"unquote-splice"===v.first?cons("append",cons(v.rest.first,cons(w(a.rest),null))):cons("cons",cons(w(v),cons(w(a.rest),null))):"string"===typeof v&&"."===v?cons("quote",cons(a.rest.first,null)):cons("cons",cons(cons("quote",cons(v,null)),cons(w(a.rest),null)))},t=function(a,c,d){if(null===a&&null===c)return d;if(null===a&&null!==c||null!==
a&&null===c&&"."!==a.first)return 0;if(a.first instanceof $List&&c.first instanceof $List)return t(a.first,c.first,d)?t(a.rest,c.rest,d):0;if(a.first instanceof $List&&!(c.first instanceof $List))return 0;if("string"===typeof a.first&&"#"===a.first[0])return"string"!==typeof c.first?0:a.first.slice(1)===c.first?t(a.rest,c.rest,d):0;if("string"===typeof a.first&&"."===a.first)return d[a.rest.first]=c,d;d[a.first]=c.first;return t(a.rest,c.rest,d)},D=function(a,c){for(var g=function(a){if(null===a)return null;
if(a.first instanceof $List)return cons(cons("list",g(a.first)),g(a.rest));if('"'===a.first[0]){for(var b="",c=0;c<a.first.length;c++)b='"'===a.first[c]?b+'\\"':"\\"===a.first[c]?b+"\\\\":"\n"===a.first[c]?b+"\\n":"\t"===a.first[c]?b+"\\t":b+a.first[c];return cons('"'+b+'"',g(a.rest))}return null===a.first?cons(a.first,g(a.rest)):cons('"'+a.first+'"',g(a.rest))};null!=a;){var b=t(a.first,c,{});if(b){var f="(function(){";for(key in b)f=b[key]instanceof $List?f+("var "+key+" = "+d(cons("list",g(b[key])))+
"; "):null===b[key]?f+("var "+key+" = null; "):f+("var "+key+" = "+d('"'+b[key])+'"; ');f+="return ("+d(a.rest.first)+");";f+="})();";if(node_environment)try{return vm.runInContext(f,z,"lisp.vm")}catch(k){return console.log(k),""}else try{return window.eval(f)}catch(h){return console.log(h),""}}a=a.rest.rest}console.log("ERROR: Failed to expand macro\n");return""},C=function(a){for(var c="",g=!1;null!=a;){var b=a.first,b=d(b,null,null,null,!0);if("string"===typeof b&&":"===b[0])for(!1===g?(c+="(",
g=!0):c+=", ",c+="{"+b.slice(1)+": "+d(a.rest.first,null,null,null,!0),a=a.rest.rest;;){if(null===a){c+="}";break}b=d(a.first,null,null,null,!0);if(":"!==b[0]){if("."===b[0]){if(c+="})",c+=y(b),g=!1,null===a.rest||"."===a.rest.first[0])c+="()"}else c+="}, "+b;break}if(null===a.rest)return console.log("ERROR: Invalid parameter name"),"";var f=d(a.rest.first,null,null,null,!0),c=c+(", "+b.slice(1)+": "+f);a=a.rest.rest}else if("."===b[0]){if(!0===g&&(c+=")"),c+=y(b),g=!1,null===a.rest||"."===a.rest.first[0])c+=
"()"}else!1===g?(c+="(",g=!0):c+=", ",c+=b;if(null===a||null===a.rest)break;a=a.rest}g&&(c+=")");return 0===c.trim().length?"()":c},y=function(a){if('"'===a[0]||"."==a[0]){var c="."===a[0]?a.slice(1):a.slice(1,-1);return c===B(c)&&isNaN(c)?"."+c:"["+a+"]"}return"["+a+"]"};d=function(a,c,n,b,f,k){if(null===a)return b?"return null":"null";if(a instanceof $List){var h=car(a);if("def"===h||"="===h||"set!"===h||"const"===h){n=car(cdr(a));var m=null,m=null===cdr(cdr(a))?null:null!=cdr(cdr(cdr(a)))?cons("fn",
cons(car(cdr(cdr(a))),cdr(cdr(cdr(a))))):a.rest.rest.first;n=d(n);var m=d(m,null,null,null,!0,n),e=("def"===h?"var ":"const"===h?"const ":"")+n+" = "+m+" ";return b?e+"; return "+n:e}if("Array"===h){e=b?"return [":"[";for(a=cdr(a);null!=a;)e+=d(car(a),null,null,null,!0),null!=cdr(a)&&(e+=", "),a=cdr(a);return e+"]"}if("Object"===h){e=b?"return {":"{";for(a=a.rest;null!=a;){var l=d(a.first,null,null,null,!0);if(":"===l[0])if(null!==a.rest&&":"!==a.rest.first[0])k=l.slice(1),k=B(k)===k&&isNaN(k)?k:
'"'+k+'"',e+=k+": ";else{e+=l.slice(1)+(null==a.rest?"":", ");a=a.rest;continue}else e="'"===l[0]||'"'===l[0]?e+(l+": "):e+("["+l+"]: ");k=d(a.rest.first,null,null,null,!0);e+=k;null!=a.rest.rest&&(e+=", ");a=a.rest.rest}return e+="}"}if("quote"===h||"quasiquote"===h)return a.rest.first instanceof $List?(f=d("quote"===h?x(a.rest.first):w(a.rest.first)),b?"return "+f:f):null===a.rest?b?"return null":"null":isNaN(a.rest.first)?b?'return "'+a.rest.first+'"':'"'+a.rest.first+'"':b?"return "+a.rest.first:
a.rest.first;if("fn"===h||"fn*"===h){e="fn"===h?"function ":"function* ";b&&(e="return "+e);b="";"string"===typeof a.rest.first?(k=a.rest.first,b+=a.rest.first+"(",f=a.rest.rest.first,a=a.rest.rest.rest):(b+="(",f=a.rest.first,a=a.rest.rest);c=[];for(var q={},h=0,t=!1,u=null;null!=f;){var p=f.first;if("string"!==typeof p){if("Object"!==p.first)return console.log("ERROR: Invalid parameters"),"";h++;for(p=p.rest;null!==p;)n=d(p.first),n='"'===n[0]?n.slice(1,-1):n,n=":"===n[0]?n.slice(1):n,m=d(p.rest.first,
null,null,null,!0),q[n]=m,p=p.rest.rest;b+="__lisp_args__";f=f.rest;null!==f&&"&"!==f.first&&"."!==f.first&&(b+=", ");c.push(q)}else{p=d(p);if("&"===p){h++;u=d(f.rest.first);break}else if("."===p){h++;f=f.rest;u=p=d(f.first);t=!0;break}else if(":"===p[0]){h++;n=p.slice(1);b+=n;c.push([n,d(f.rest.first,null,null,null,!0)]);f=f.rest.rest;null!=f&&"&"!==f.first&&"."!==f.first&&(b+=", ");continue}else h++,b+=p,null!=f.rest&&"&"!==f.rest.first&&"."!==f.rest.first&&(b+=", ");f=f.rest}}n=[k?k:!1];b+="){";
u&&(b+="for(var "+u+" = [], $__0 = "+(h-1)+"; $__0 < arguments.length; $__0++)"+u+"[$__0 - "+(h-1)+"] = arguments[$__0];",t&&(b+=u+" = list.apply(null, "+u+");"));for(m=0;m<c.length;m++)if(f=c[m],f.constructor===Array)h=f[0],b+=h+" = ("+h+" === void 0 ? "+f[1]+" : "+h+" );";else for(l in b+="var __lisp_args_v__;",b+="__lisp_args__ = (__lisp_args__ === void 0 ? {} : __lisp_args__); ",f)b+="var "+l+" = ((__lisp_args_v__ = __lisp_args__."+l+") === void 0 ? "+f[l]+" : __lisp_args_v__); ";b+=r(a,!0,null,
n);!1!==n[0]&&n[0]!==k&&(e+=n[0]);return e+(b+"}")}if("let"===h){k={};f=cdr(a);for(e="((function(){";null!=f.rest;)n=f.first,l=f.rest.first,typeof("string"===n)?n in k?e+=n+" = "+d(l)+"; ":(k[n]=!0,e+="var "+n+" = "+d(l)+"; "):console.log("let implementation not finished yet"),f=f.rest.rest;e+=d(f.first,null,null,!0);e+="})())";return(b?"return ":"")+e}if("cond"===h){m=!1;c=a.rest;e="if(";f&&(e="(function(){"+e);l=d(c.first,null,null,null,!0,null);e=e+l+"){";a=c.rest.first;e+=d(a,!0,n,b||f,null,k);
e+="}";for(c=c.rest.rest;null!=c;)if(e+=" else ","else"!==c.first)e+="if (",l=d(c.first),e=e+l+"){",a=c.rest.first,e+=d(a,!0,n,b||f,null,k),e+="}",c=c.rest.rest;else{m=!0;e+="{";a=c.rest.first;e+=d(a,!0,n,b||f,null,k);e+="}";break}!1===m&&b&&(e+=" else return null");f&&(e+="})()");return e}if("if"===h)return e="(",l=a.rest.first,k=a.rest.rest.first,a=null===a.rest.rest.rest?null:a.rest.rest.rest.first,f?(e+=d(l)+" ? ",e+=d(k,c,n,null,!0,null)+" : ",e+=d(a,c,n,null,!0,null)+")"):null===a?d(list("cond",
l,k),c,n,b,f):d(list("cond",l,k,"else",a),c,n,b,f);if("do"===h)return f?"(function (){"+r(a.rest,!0)+"})()":r(a.rest,b,null,n);if("apply"===h)return k=d(a.rest.first),f=d(a.rest.rest.first,null,null,null,!0),(b?"return ":"")+"("+k+").apply(this, (function(){var temp = "+f+"; return temp instanceof $List ? temp.toArray() : temp})())";if("new"===h)return k=d(a.rest.first),e="(new "+k+""+C(a.rest.rest),e+=")",(b?"return ":"")+e;if("+"===h||"-"===h||"*"===h||"/"===h||"%"===h||"=="===h||"<"===h||">"===
h||"!="===h||"<="===h||">="===h||"&&"===h||"||"===h||"&"===h||"|"===h||"and"===h||"or"===h){e="(";f=a.rest;if(null==f.rest)return"+"===h||"*"===h||"%"===h?(b?"return ":"")+d(f.first,null,null,null,!0):"-"===h?(b?"return ":"")+"(-"+d(f.first,null,null,null,!0)+")":"/"===h?(b?"return ":"")+"(1/"+d(f.first,null,null,null,!0)+")":(b?"return ":"")+"true";for(;null!=f;)p=d(f.first,null,null,null,!0),e+=p,null!=f.rest&&("and"===h?h="&&":"or"===h?h="||":"=="==h&&(h="==="),e+=" "+h+" "),f=f.rest;return(b?
"return ":"")+e+")"}if("not"===h)return(b?"return ":"")+"(!"+d(a.rest.first,null,null,null,!0)+")";if("instanceof"===h)return(b?"return ":"")+"("+d(a.rest.first)+" instanceof "+d(a.rest.rest.first)+")";if("get"===h){e=f=d(a.rest.first,null,null,null,!0);for(k=a.rest.rest;null!==k;)l=d(k.first,null,null,null,!0),e+=y(l),k=k.rest;return(b?"return ":"")+e}if("->"===h){e=f=d(a.rest.first,null,null,null,!0);for(k=a.rest.rest;null!==k;)n=!1,k.first instanceof $List?(n=!0,l=d(k.first.first,null,null,null,
!0)):l=d(k.first,null,null,null,!0),e+=y(l),n&&(f=k.first.rest,e+=C(f)),k=k.rest;return(b?"return ":"")+e}if("try"===h)return c=a.rest,a=c.first,e="try{"+d(a,!0,n,b||f,null,k),e+="}",c=c.rest,null!=c&&"catch"===c.first&&(e+="catch(",l=d(c.rest.first),e+=l+"){",a=c.rest.rest.first,e+=d(a,!0,n,b||f,null,k),e+="}",c=c.rest.rest.rest),null!=c&&"finally"===c.first&&(a=c.rest.first,e+="finally {",e+=d(a,!0,n,b||f,null,k),e+="}"),e;if("throw"===h||"yield"===h)return h+" "+d(a.rest.first,null,null,null,!0)+
(b?"; return;":"");if("in"===h)return(b?"return ":"")+"("+d(a.rest.first)+" in "+d(a.rest.rest.first)+")";if("defmacro"===h){e=d(a.rest.first);if("string"!=typeof e)return console.log("ERROR: Invalid macro name: "+e.toString()),"";c=a.rest.rest;g[e]=c;return""}k=a.first;f=a.rest;k=d(k);"recur"===k&&c&&(!1===n[0]&&(n[0]="__lisp__recur__$"+s,s+=3),k=n[0],a.first=k);e=k;"}"!==k[k.length-1]&&isNaN(k)||(e="("+e+")");if(k in g)return e=D(g[k],f),(b?"return ":"")+d(e);e+=C(f);return(b?"return ":"")+e}return isNaN(a)&&
"'"!==a[0]&&'"'!==a[0]&&":"!==a[0]?(b?"return ":"")+B(a):(b?"return ":"")+a};r=function(a,c,g,b){for(var f="",k,h=!1;null!=a;){c&&null==a.rest&&(h=!0);k=d(a.first,null===a.rest?!0:!1,b,h);"string"===typeof k&&(k=k.trim());"string"===typeof k&&0!==k.length&&";"!==k[k.length-1]&&(k+="; ");if(g)if(node_environment)try{m=vm.runInContext(k,z,"lisp.vm")}catch(l){console.log(l)}else try{window.eval(k)}catch(e){console.log(e)}f+=k;a=a.rest}return f};return{lexer:l,parser:q,compiler:d,lisp_compiler:r,compile:function(a){a=
l(a);if(null===a)return null;a=q(a);return r(a,!1,!0)},getEvalResult:function(){return m}}},lisp=lisp_module();"undefined"!==typeof module&&(module.exports.compile=lisp.compile,module.exports.getEvalResult=lisp.getEvalResult);
